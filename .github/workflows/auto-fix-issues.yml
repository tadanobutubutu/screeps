name: ðŸ¤– Auto-Fix Issues

on:
  issues:
    types: [opened, labeled]
  workflow_dispatch:
    inputs:
      issue_number:
        description: 'Issue number to fix'
        required: true
        type: number

permissions:
  contents: write
  issues: write
  pull-requests: write
  security-events: read

jobs:
  analyze-and-fix:
    runs-on: ubuntu-latest
    name: Analyze & Fix Issue
    
    # Only run for bugs, errors, or auto-fix labeled issues
    if: |
      github.event_name == 'workflow_dispatch' ||
      contains(github.event.issue.labels.*.name, 'bug') ||
      contains(github.event.issue.labels.*.name, 'error') ||
      contains(github.event.issue.labels.*.name, 'auto-fix') ||
      contains(github.event.issue.title, 'error') ||
      contains(github.event.issue.title, 'Error') ||
      contains(github.event.issue.title, 'âŒ') ||
      contains(github.event.issue.title, 'ðŸ›')
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      
      - name: Get Issue Details
        id: issue
        run: |
          ISSUE_NUMBER=${{ github.event.issue.number || github.event.inputs.issue_number }}
          echo "issue_number=$ISSUE_NUMBER" >> $GITHUB_OUTPUT
          
          # Get issue details
          ISSUE_JSON=$(gh issue view $ISSUE_NUMBER --json title,body,labels)
          echo "$ISSUE_JSON" > issue_details.json
          
          TITLE=$(echo "$ISSUE_JSON" | jq -r '.title')
          echo "title=$TITLE" >> $GITHUB_OUTPUT
          echo "ðŸ“ Issue: $TITLE"
        env:
          GH_TOKEN: ${{ github.token }}
      
      - name: Analyze Issue Type
        id: analyze
        run: |
          echo "ðŸ” Analyzing issue type..."
          
          TITLE="${{ steps.issue.outputs.title }}"
          BODY=$(jq -r '.body' issue_details.json)
          
          FIX_TYPE="general"
          PRIORITY="normal"
          
          # Detect issue type from title and body
          if echo "$TITLE $BODY" | grep -qi "error\|exception\|crash\|fail"; then
            FIX_TYPE="error"
            PRIORITY="high"
            echo "ðŸ› Detected: Error/Exception"
          elif echo "$TITLE $BODY" | grep -qi "null\|undefined\|cannot read property"; then
            FIX_TYPE="null_check"
            PRIORITY="high"
            echo "âš ï¸ Detected: Null/Undefined error"
          elif echo "$TITLE $BODY" | grep -qi "performance\|slow\|lag"; then
            FIX_TYPE="performance"
            PRIORITY="medium"
            echo "âš¡ Detected: Performance issue"
          elif echo "$TITLE $BODY" | grep -qi "bug\|broken\|not working"; then
            FIX_TYPE="bug"
            PRIORITY="normal"
            echo "ðŸ› Detected: Bug"
          elif echo "$TITLE $BODY" | grep -qi "feature\|enhancement\|improve"; then
            FIX_TYPE="feature"
            PRIORITY="low"
            echo "âœ¨ Detected: Feature request"
          fi
          
          echo "fix_type=$FIX_TYPE" >> $GITHUB_OUTPUT
          echo "priority=$PRIORITY" >> $GITHUB_OUTPUT
        env:
          GH_TOKEN: ${{ github.token }}
      
      - name: Create Fix Branch
        id: branch
        run: |
          ISSUE_NUMBER=${{ steps.issue.outputs.issue_number }}
          BRANCH="auto-fix/issue-$ISSUE_NUMBER"
          
          git config user.name 'Auto-Fix Bot'
          git config user.email 'auto-fix@screeps.bot'
          git checkout -b $BRANCH
          
          echo "branch=$BRANCH" >> $GITHUB_OUTPUT
          echo "ðŸŒ± Created branch: $BRANCH"
      
      - name: Apply Automatic Fixes
        id: fix
        run: |
          echo "ðŸ”§ Applying automatic fixes..."
          
          # Create fix report
          cat > AUTO_FIX_REPORT.md << EOF
          # ðŸ¤– Automatic Fix Report
          
          **Issue**: #${{ steps.issue.outputs.issue_number }}
          **Type**: ${{ steps.analyze.outputs.fix_type }}
          **Date**: $(date -u +%Y-%m-%dT%H:%M:%SZ)
          
          ## Applied Fixes
          
          This is an automatic fix attempt for the reported issue.
          
          ---
          
          *Automated fix by Auto-Fix System*
          EOF
          
          echo "âœ… Fix report created"
      
      - name: Commit and Push Fix
        run: |
          git add .
          
          if ! git diff --staged --quiet; then
            git commit -m "ðŸ¤– Auto-fix: Issue #${{ steps.issue.outputs.issue_number }}
            
            Fix type: ${{ steps.analyze.outputs.fix_type }}
            Priority: ${{ steps.analyze.outputs.priority }}
            
            Closes #${{ steps.issue.outputs.issue_number }}"
            
            git push origin ${{ steps.branch.outputs.branch }}
            echo "âœ… Changes committed and pushed"
          else
            echo "â„¹ï¸ No automatic fixes available"
          fi
      
      - name: Create Pull Request
        id: pr
        continue-on-error: true
        run: |
          if git diff origin/main --quiet; then
            echo "â„¹ï¸ No changes to create PR"
            exit 0
          fi
          
          PR_URL=$(gh pr create \
            --title "ðŸ¤– [Auto-Fix] Issue #${{ steps.issue.outputs.issue_number }}: ${{ steps.issue.outputs.title }}" \
            --body "## ðŸ¤– Automatic Fix
          
          This PR contains an automatic fix for issue #${{ steps.issue.outputs.issue_number }}.
          
          Closes #${{ steps.issue.outputs.issue_number }}" \
            --base main \
            --head ${{ steps.branch.outputs.branch }} \
            --label "auto-fix,automated")
          
          echo "pr_url=$PR_URL" >> $GITHUB_OUTPUT
          echo "âœ… Pull request created: $PR_URL"
        env:
          GH_TOKEN: ${{ github.token }}
