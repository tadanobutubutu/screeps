name: üè∑Ô∏è Auto-Label Issues

on:
  issues:
    types: [opened, edited]

permissions:
  issues: write

jobs:
  auto-label:
    runs-on: ubuntu-latest
    name: Automatically Label Issues
    
    steps:
      - name: Analyze and Label Issue
        run: |
          echo "üè∑Ô∏è Analyzing issue..."
          
          ISSUE_NUMBER=${{ github.event.issue.number }}
          TITLE="${{ github.event.issue.title }}"
          BODY="${{ github.event.issue.body }}"
          
          LABELS=""
          
          # Detect issue type from title and body
          CONTENT="$TITLE $BODY"
          
          # Error/Bug detection
          if echo "$CONTENT" | grep -qi "error\|exception\|crash\|fail\|\u274c"; then
            LABELS="$LABELS,bug,error"
            echo "üêõ Detected: Bug/Error"
          fi
          
          # Null/Undefined
          if echo "$CONTENT" | grep -qi "null\|undefined\|cannot read property\|cannot convert"; then
            LABELS="$LABELS,null-error"
            echo "‚ö†Ô∏è Detected: Null/Undefined error"
          fi
          
          # Performance
          if echo "$CONTENT" | grep -qi "performance\|slow\|lag\|timeout\|cpu"; then
            LABELS="$LABELS,performance"
            echo "‚ö° Detected: Performance issue"
          fi
          
          # Feature request
          if echo "$CONTENT" | grep -qi "feature\|enhancement\|improve\|add\|\u2728"; then
            LABELS="$LABELS,enhancement"
            echo "‚ú® Detected: Feature request"
          fi
          
          # Documentation
          if echo "$CONTENT" | grep -qi "documentation\|docs\|readme\|wiki"; then
            LABELS="$LABELS,documentation"
            echo "üìö Detected: Documentation"
          fi
          
          # Security
          if echo "$CONTENT" | grep -qi "security\|vulnerability\|exploit\|unsafe"; then
            LABELS="$LABELS,security"
            echo "üîí Detected: Security issue"
          fi
          
          # Workflow
          if echo "$CONTENT" | grep -qi "workflow\|action\|ci\|cd\|github"; then
            LABELS="$LABELS,workflow"
            echo "üîß Detected: Workflow issue"
          fi
          
          # Question
          if echo "$CONTENT" | grep -qi "how to\|how do\|question\|help\|\?"; then
            LABELS="$LABELS,question"
            echo "‚ùì Detected: Question"
          fi
          
          # Priority detection
          if echo "$CONTENT" | grep -qi "urgent\|critical\|asap\|important"; then
            LABELS="$LABELS,urgent"
            echo "üî¥ Detected: Urgent"
          fi
          
          # Auto-fixable
          if echo "$CONTENT" | grep -qi "syntax\|typo\|formatting\|null\|undefined"; then
            LABELS="$LABELS,auto-fix"
            echo "ü§ñ Detected: Auto-fixable"
          fi
          
          # Remove leading comma
          LABELS=$(echo "$LABELS" | sed 's/^,//')
          
          if [ -n "$LABELS" ]; then
            echo "üè∑Ô∏è Adding labels: $LABELS"
            
            # Convert comma-separated to array and add labels
            IFS=',' read -ra LABEL_ARRAY <<< "$LABELS"
            for label in "${LABEL_ARRAY[@]}"; do
              gh issue edit $ISSUE_NUMBER --add-label "$label" 2>/dev/null || echo "Label $label not found (will be created)"
            done
            
            echo "‚úÖ Labels added"
          else
            echo "‚ÑπÔ∏è No automatic labels detected"
          fi
        env:
          GH_TOKEN: ${{ github.token }}
      
      - name: Add Auto-Fix Comment
        if: contains(github.event.issue.title, 'error') || contains(github.event.issue.title, 'Error')
        run: |
          ISSUE_NUMBER=${{ github.event.issue.number }}
          
          # Check if auto-fix comment already exists
          EXISTING=$(gh issue view $ISSUE_NUMBER --json comments --jq '.comments[].body' | grep -c "Auto-Fix System" || echo "0")
          
          if [ "$EXISTING" = "0" ]; then
            gh issue comment $ISSUE_NUMBER --body "ü§ñ **Auto-Fix System**
            
            This issue appears to be an error or bug. The auto-fix system will analyze it and attempt to create an automatic fix.
            
            ## What happens next?
            
            1. üîç Issue will be analyzed
            2. ü§ñ Automatic fix will be attempted
            3. üîÑ Pull request will be created
            4. üëÄ Review and merge the fix
            
            You can also manually trigger the fix by adding the \`auto-fix\` label.
            
            ---
            
            *Automated by Auto-Label System*"
          fi
        env:
          GH_TOKEN: ${{ github.token }}
