name: üîß Workflow Health Monitor

on:
  schedule:
    - cron: '0 */6 * * *'  # Every 6 hours
  workflow_dispatch:
  workflow_run:
    workflows: ["*"]
    types:
      - completed

permissions:
  contents: write
  actions: write
  issues: write
  pull-requests: write

jobs:
  check-workflow-health:
    runs-on: ubuntu-latest
    name: Check & Fix Workflow Issues
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      
      - name: Ensure Labels Exist
        run: |
          echo "üè∑Ô∏è Ensuring labels exist..."
          
          # Function to create label if it doesn't exist
          create_label_if_missing() {
            local name="$1"
            local color="$2"
            local description="$3"
            
            if ! gh label list --json name --jq '.[].name' | grep -q "^${name}$"; then
              gh label create "$name" --color "$color" --description "$description" || echo "‚ö†Ô∏è Could not create label $name"
              echo "‚úÖ Created label: $name"
            fi
          }
          
          create_label_if_missing "workflow-health" "FF6B6B" "Workflow health monitoring"
          create_label_if_missing "automated" "95E1D3" "Automated by bots"
          create_label_if_missing "workflow-fix" "4ECDC4" "Workflow fixes"
        env:
          GH_TOKEN: ${{ github.token }}
      
      - name: Analyze Recent Workflow Runs
        id: analyze
        run: |
          echo "üîç Analyzing recent workflow runs..."
          
          # Get failed workflows from last 24 hours
          FAILED_RUNS=$(gh run list --limit 50 --json status,conclusion,name,createdAt,databaseId,workflowName | \
            jq -r '[.[] | select(.conclusion == "failure" or .conclusion == "cancelled")] | length')
          
          echo "failed_count=$FAILED_RUNS" >> $GITHUB_OUTPUT
          echo "üìä Found $FAILED_RUNS failed/cancelled runs in last 50"
          
          # Get detailed info about failures
          gh run list --limit 50 --json status,conclusion,name,createdAt,databaseId,workflowName | \
            jq '[.[] | select(.conclusion == "failure" or .conclusion == "cancelled") | {workflow: .workflowName, name: .name, id: .databaseId, created: .createdAt}]' > failed_workflows.json
          
          if [ $FAILED_RUNS -gt 0 ]; then
            echo "has_failures=true" >> $GITHUB_OUTPUT
            echo "‚ö†Ô∏è Workflow failures detected!"
            cat failed_workflows.json
          else
            echo "has_failures=false" >> $GITHUB_OUTPUT
            echo "‚úÖ All workflows healthy"
          fi
        env:
          GH_TOKEN: ${{ github.token }}
      
      - name: Generate Workflow Health Report
        if: steps.analyze.outputs.has_failures == 'true'
        run: |
          cat > WORKFLOW_HEALTH.md << 'EOF'
          # üîß Workflow Health Report
          
          **Generated**: $(date -u +%Y-%m-%dT%H:%M:%SZ)
          
          ## üìä Status
          
          - **Failed Runs**: ${{ steps.analyze.outputs.failed_count }}
          - **Analysis**: Complete
          
          ## üêõ Detected Issues
          
          $(cat failed_workflows.json | head -50)
          
          ## üîß Recommended Actions
          
          ### 1. Missing Labels
          Some workflows may fail because required labels don't exist.
          - Run "Setup Labels" workflow to create them
          - Or manually create labels in repository settings
          
          ### 2. API Token Configuration
          If workflows fail due to missing tokens:
          - Set `SCREEPS_PROD_TOKEN` in GitHub Secrets (optional)
          - Workflows will gracefully skip API features if not set
          
          ### 3. Workflow Syntax
          - Check YAML syntax
          - Validate workflow structure
          
          ### 4. Permissions
          - Ensure workflows have necessary permissions
          - Check repository settings
          
          ## üìù Next Steps
          
          1. Review this report
          2. Run "Setup Labels" workflow
          3. Re-run failed workflows
          4. Monitor for 24 hours
          
          EOF
          
          echo "üìù Generated health report"
      
      - name: Commit Health Report
        if: steps.analyze.outputs.has_failures == 'true'
        run: |
          git config user.name 'Workflow Health Bot'
          git config user.email 'workflow-health@screeps.bot'
          git add WORKFLOW_HEALTH.md failed_workflows.json
          git diff --staged --quiet || (
            git commit -m "üîß Workflow health report: ${{ steps.analyze.outputs.failed_count }} issues"
            git push
          )
      
      - name: Create Issue for Failed Workflows
        if: steps.analyze.outputs.has_failures == 'true'
        continue-on-error: true
        run: |
          # Check if issue already exists
          EXISTING=$(gh issue list --label "workflow-health" --state open 2>/dev/null | wc -l || echo "0")
          
          if [ "$EXISTING" -gt 0 ]; then
            echo "‚ÑπÔ∏è Issue already exists"
            exit 0
          fi
          
          # Try to create issue without label first, then add label
          ISSUE_URL=$(gh issue create \
            --title "üîß Workflow Health Issues Detected" \
            --body "## ‚ö†Ô∏è Workflow Failures
          
          **Failed Runs**: ${{ steps.analyze.outputs.failed_count }}
          **Detection Time**: $(date -u +%Y-%m-%dT%H:%M:%SZ)
          
          ### üêõ Issues Found
          
          See [WORKFLOW_HEALTH.md](../blob/main/WORKFLOW_HEALTH.md) for details.
          
          ### üìù Quick Fixes
          
          1. **Missing Labels**: Run the \"Setup Labels\" workflow
          2. **API Token**: Optional - set \`SCREEPS_PROD_TOKEN\` in Secrets
          3. **Permissions**: Check workflow permissions
          
          ### üöÄ Actions
          
          1. Go to [Actions](../../actions/workflows/setup-labels.yml)
          2. Click \"Run workflow\"
          3. Wait for completion
          4. Re-run failed workflows
          
          ---
          
          **Auto-generated by Workflow Health Monitor**")
          
          # Try to add label
          if [ -n "$ISSUE_URL" ]; then
            ISSUE_NUMBER=$(echo "$ISSUE_URL" | grep -o '[0-9]*$')
            gh issue edit "$ISSUE_NUMBER" --add-label "workflow-health,automated" 2>/dev/null || \
              echo "‚ö†Ô∏è Could not add labels (they may not exist yet)"
          fi
        env:
          GH_TOKEN: ${{ github.token }}
      
      - name: Summary
        if: always()
        run: |
          echo "üìä Workflow Health Check Complete"
          echo "Failed workflows: ${{ steps.analyze.outputs.failed_count }}"
          if [ "${{ steps.analyze.outputs.failed_count }}" = "0" ]; then
            echo "‚úÖ All workflows are healthy!"
          else
            echo "‚ö†Ô∏è Some workflows need attention"
            echo "See WORKFLOW_HEALTH.md for details"
          fi
