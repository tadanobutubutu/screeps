name: ðŸ“š Auto Update Documentation

on:
  push:
    branches:
      - main
    paths:
      - '.github/workflows/**'
      - 'role.*.js'
      - '*.js'
  schedule:
    # Weekly on Sunday at 1 AM JST (Saturday 4 PM UTC)
    - cron: '0 16 * * 6'
  workflow_dispatch:

permissions:
  contents: write

jobs:
  update-docs:
    runs-on: ubuntu-latest
    name: Update Documentation Files
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v6
        with:
          node-version: '20'
      
      - name: Analyze repository and update README
        run: |
          node -e "
          const fs = require('fs');
          const path = require('path');
          
          console.log('ðŸ“Š Analyzing repository...');
          
          // ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ãƒ•ã‚¡ã‚¤ãƒ«ã‚’å–å¾—
          const workflowDir = '.github/workflows';
          const workflowFiles = fs.readdirSync(workflowDir)
            .filter(f => f.endsWith('.yml') || f.endsWith('.yaml'))
            .map(f => {
              const content = fs.readFileSync(path.join(workflowDir, f), 'utf8');
              const nameMatch = content.match(/name:\s*(.+)/);
              const scheduleMatch = content.match(/cron:\s*'([^']+)'/);
              return {
                file: f,
                name: nameMatch ? nameMatch[1].trim() : f,
                hasSchedule: !!scheduleMatch,
                schedule: scheduleMatch ? scheduleMatch[1] : null
              };
            });
          
          console.log(\`âœ… Found \${workflowFiles.length} workflows\`);
          
          // ãƒ­ãƒ¼ãƒ«ãƒ•ã‚¡ã‚¤ãƒ«ã‚’å–å¾—
          const roleFiles = fs.readdirSync('.')
            .filter(f => f.startsWith('role.') && f.endsWith('.js'))
            .map(f => f.replace('role.', '').replace('.js', ''));
          
          console.log(\`âœ… Found \${roleFiles.length} role files\`);
          
          // JSãƒ•ã‚¡ã‚¤ãƒ«ã‚’å–å¾—ï¼ˆçµ±è¨ˆç”¨ï¼‰
          const jsFiles = fs.readdirSync('.')
            .filter(f => f.endsWith('.js') && !f.startsWith('node_modules'));
          
          const totalLines = jsFiles.reduce((sum, file) => {
            const content = fs.readFileSync(file, 'utf8');
            return sum + content.split('\\n').length;
          }, 0);
          
          console.log(\`âœ… Total \${jsFiles.length} JS files with \${totalLines} lines\`);
          
          // README.md ã‚’æ›´æ–°
          const readme = \`# ðŸŽ® Screeps AI - å®Œå…¨è‡ªå‹•åŒ–ãƒªãƒã‚¸ãƒˆãƒª

> Screeps AI code repository with **full automation** - no API keys required!

[![GitHub Actions](https://img.shields.io/badge/Automation-GitHub%20Actions-blue)](https://github.com/tadanobutubutu/screeps/actions)
[![Workflows](https://img.shields.io/badge/Workflows-\${workflowFiles.length}-green)](.github/workflows)
[![Roles](https://img.shields.io/badge/Roles-\${roleFiles.length}-orange)](./)
[![Lines](https://img.shields.io/badge/Lines-\${totalLines}-purple)](./)

## ðŸš€ ç‰¹å¾´

- âœ… **APIä¸è¦**: å¤–éƒ¨APIã‚­ãƒ¼ä¸è¦ã§å®Œå…¨ç„¡æ–™
- ðŸ¤– **å®Œå…¨è‡ªå‹•åŒ–**: æ”¾ç½®ã§è‡ªå‹•æ”¹å–„ãƒ»æ‹¡å¼µ
- ðŸ“Š **ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ç›£è¦–**: ã‚²ãƒ¼ãƒ çŠ¶æ³ã‚’GitHubã§ç¢ºèª
- ðŸ†• **è‡ªå‹•æ‹¡å¼µ**: æ–°ã—ã„ãƒ­ãƒ¼ãƒ«ãŒé€±æ¬¡ã§è¿½åŠ 

## ðŸ“Š ã‚²ãƒ¼ãƒ çŠ¶æ³

**ç¾åœ¨ã®çŠ¶æ³ã‚’ç¢ºèª**: [\`GAME_STATUS.md\`](./GAME_STATUS.md)

æ¯Žæ™‚è‡ªå‹•æ›´æ–°ã•ã‚Œã‚‹ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ãƒ¬ãƒãƒ¼ãƒˆï¼š
- ðŸ‘¤ ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼æƒ…å ± (GCL, CPU, Credits)
- ðŸ° æ‰€æœ‰éƒ¨å±‹ã®çŠ¶æ³
- ðŸ› ã‚¯ãƒªãƒ¼ãƒ—çµ±è¨ˆ
- ðŸ’¾ ãƒ¡ãƒ¢ãƒªä½¿ç”¨çŽ‡

## ðŸ¤– è‡ªå‹•åŒ–ã‚·ã‚¹ãƒ†ãƒ 

### ðŸ“‹ ç¨¼åƒä¸­ã®ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ (\${workflowFiles.length}å€‹)

\${workflowFiles.map(wf => \`- **\${wf.name}** (\\\`\${wf.file}\\\`)\${wf.hasSchedule ? \` - å®šæœŸå®Ÿè¡Œ\` : \` - ã‚¤ãƒ™ãƒ³ãƒˆé§†å‹•\`}\`).join('\\n')}

è©³ã—ãã¯ [\`WORKFLOWS.md\`](./WORKFLOWS.md) ã‚’å‚ç…§ã—ã¦ãã ã•ã„ã€‚

## ðŸ› å®Ÿè£…æ¸ˆã¿ãƒ­ãƒ¼ãƒ« (\${roleFiles.length}å€‹)

\${roleFiles.map((role, i) => \`\${i + 1}. **\${role}** - \\\`role.\${role}.js\\\`\`).join('\\n')}

## ðŸ“ˆ çµ±è¨ˆæƒ…å ±

- ðŸ“„ **JSãƒ•ã‚¡ã‚¤ãƒ«æ•°**: \${jsFiles.length}
- ðŸ“ **ç·ã‚³ãƒ¼ãƒ‰è¡Œæ•°**: \${totalLines}
- ðŸ”„ **ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼æ•°**: \${workflowFiles.length}
- ðŸŽ­ **ãƒ­ãƒ¼ãƒ«æ•°**: \${roleFiles.length}

*æœ€çµ‚æ›´æ–°: \${new Date().toISOString().split('T')[0]}*

## ðŸ”§ ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—

### 1. Steamç‰ˆè³¼å…¥å¾Œ

1. Screepså…¬å¼ã‚µã‚¤ãƒˆã§ãƒ­ã‚°ã‚¤ãƒ³
2. Account Settings â†’ API Access ã§ãƒˆãƒ¼ã‚¯ãƒ³ç”Ÿæˆ
3. GitHubãƒªãƒã‚¸ãƒˆãƒª Settings â†’ Secrets ã§ \`SCREEPS_TOKEN\` ã«è¨­å®š
4. mainãƒ–ãƒ©ãƒ³ãƒã«pushã™ã‚Œã°è‡ªå‹•ãƒ‡ãƒ—ãƒ­ã‚¤é–‹å§‹

### 2. ãƒ­ãƒ¼ã‚«ãƒ«é–‹ç™º (ã‚ªãƒ—ã‚·ãƒ§ãƒ³)

\\\`\\\`\\\`bash
git clone https://github.com/tadanobutubutu/screeps.git
cd screeps
npm install
\\\`\\\`\\\`

## ðŸ“ ãƒ•ã‚¡ã‚¤ãƒ«æ§‹æˆ

\\\`\\\`\\\`
.
â”œâ”€â”€ .github/workflows/     # è‡ªå‹•åŒ–ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ (\${workflowFiles.length}å€‹)
â”œâ”€â”€ role.*.js              # ã‚¯ãƒªãƒ¼ãƒ—ãƒ­ãƒ¼ãƒ« (\${roleFiles.length}å€‹)
â”œâ”€â”€ utils.*.js             # ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£é–¢æ•°
â”œâ”€â”€ main.js                # ãƒ¡ã‚¤ãƒ³ãƒ«ãƒ¼ãƒ—
â”œâ”€â”€ deploy.js              # ãƒ‡ãƒ—ãƒ­ã‚¤ã‚¹ã‚¯ãƒªãƒ—ãƒˆ
â”œâ”€â”€ GAME_STATUS.md         # ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ã‚²ãƒ¼ãƒ çŠ¶æ³
â”œâ”€â”€ WORKFLOWS.md           # ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼è©³ç´°èª¬æ˜Ž
â””â”€â”€ game-history/          # æ—¥ä»˜åˆ¥å±¥æ­´
\\\`\\\`\\\`

## ðŸ“š ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ

- [\`WORKFLOWS.md\`](./WORKFLOWS.md) - è‡ªå‹•åŒ–ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ã®è©³ç´°
- [\`GAME_STATUS.md\`](./GAME_STATUS.md) - ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ã‚²ãƒ¼ãƒ çŠ¶æ³
- [\`META-CHANGELOG.md\`](./META-CHANGELOG.md) - ã‚·ã‚¹ãƒ†ãƒ å¤‰æ›´å±¥æ­´
- [\`SECURITY.md\`](./SECURITY.md) - ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒãƒªã‚·ãƒ¼

## âœ¨ ä¸»ãªæ©Ÿèƒ½

### ðŸ”§ ãƒ«ãƒ¼ãƒ«ãƒ™ãƒ¼ã‚¹è‡ªå‹•æ”¹å–„

- \`console.log\` ã®å‰Šé™¤
- \`var\` ã‚’ \`const\` ã«å¤‰æ›´
- éžåŠ¹çŽ‡ãªãƒ«ãƒ¼ãƒ—ã®æœ€é©åŒ–
- ãƒ¡ãƒ¢ãƒªã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—ã®è‡ªå‹•è¿½åŠ 

### ðŸŽ² ãƒ©ãƒ³ãƒ€ãƒ å®Ÿé¨“

æ¯Žé€±ä»¥ä¸‹ã®ã„ãšã‚Œã‹ã‚’è‡ªå‹•è¿½åŠ ï¼š
- ðŸ“Š ãƒ‘ãƒ•ã‚©ãƒ¼ãƒžãƒ³ã‚¹ãƒ¢ãƒ‹ã‚¿ãƒ¼
- ðŸ§­ ãƒ‘ã‚¹ãƒ•ã‚¡ã‚¤ãƒ³ãƒ‡ã‚£ãƒ³ã‚°ã‚­ãƒ£ãƒƒã‚·ãƒ¥
- ðŸŽ¯ ã‚¹ãƒžãƒ¼ãƒˆã‚¹ãƒãƒ¼ãƒ³å„ªå…ˆåº¦
- ðŸ›¡ï¸ ã‚¿ãƒ¯ãƒ¼æœ€é©åŒ–
- âš¡ ã‚¨ãƒãƒ«ã‚®ãƒ¼åŠ¹çŽ‡ãƒˆãƒ©ãƒƒã‚­ãƒ³ã‚°

### ðŸ†• è‡ªå‹•ãƒ­ãƒ¼ãƒ«ä½œæˆ

æ¯Žé€±æ–°ã—ã„ãƒ­ãƒ¼ãƒ«ã‚’è‡ªå‹•ç”Ÿæˆã—ã¦ \`main.js\` ã«çµ±åˆã—ã¾ã™ã€‚

## ðŸ‘¨â€ðŸ’» è²¢çŒ®

æ”¹å–„ææ¡ˆã‚„ãƒã‚°å ±å‘Šã¯Issuesã§ãŠé¡˜ã„ã—ã¾ã™ã€‚

## ðŸ“ ãƒ©ã‚¤ã‚»ãƒ³ã‚¹

MIT License

---

**Enjoy your fully automated Screeps experience!** ðŸŽ®ðŸ¤–

*ã“ã®READMEã¯è‡ªå‹•æ›´æ–°ã•ã‚Œã¾ã™ - æœ€çµ‚æ›´æ–°: \${new Date().toISOString()}*
\`;
          
          fs.writeFileSync('README.md', readme);
          console.log('âœ… README.md updated!');
          
          // WORKFLOWS.mdã®ãƒ˜ãƒƒãƒ€ãƒ¼ã‚’æ›´æ–°
          if (fs.existsSync('WORKFLOWS.md')) {
            let workflows = fs.readFileSync('WORKFLOWS.md', 'utf8');
            
            // çµ±è¨ˆæƒ…å ±ã‚’æŒ¿å…¥
            const statsSection = \`\n> ðŸ“Š **çµ±è¨ˆ**: \${workflowFiles.length}å€‹ã®ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ | æœ€çµ‚æ›´æ–°: \${new Date().toISOString().split('T')[0]}\n\n\`;
            
            if (!workflows.includes('ðŸ“Š **çµ±è¨ˆ**')) {
              workflows = workflows.replace('# ðŸ¤–', \`# ðŸ¤–\${statsSection}\`);
              fs.writeFileSync('WORKFLOWS.md', workflows);
              console.log('âœ… WORKFLOWS.md updated!');
            }
          }
          
          // çµ±è¨ˆãƒ•ã‚¡ã‚¤ãƒ«ä½œæˆ
          const stats = {
            updated: new Date().toISOString(),
            workflows: workflowFiles.length,
            roles: roleFiles.length,
            jsFiles: jsFiles.length,
            totalLines: totalLines,
            workflowList: workflowFiles.map(wf => ({
              name: wf.name,
              file: wf.file,
              scheduled: wf.hasSchedule
            })),
            roleList: roleFiles
          };
          
          fs.writeFileSync('repo-stats.json', JSON.stringify(stats, null, 2));
          console.log('âœ… repo-stats.json created!');
          
          console.log('\nðŸ“ˆ Summary:');
          console.log(\`  Workflows: \${workflowFiles.length}\`);
          console.log(\`  Roles: \${roleFiles.length}\`);
          console.log(\`  JS Files: \${jsFiles.length}\`);
          console.log(\`  Total Lines: \${totalLines}\`);
          "
      
      - name: Commit updated documentation
        run: |
          git config user.name 'Documentation Bot'
          git config user.email 'docs@screeps.local'
          git add README.md WORKFLOWS.md repo-stats.json
          
          if ! git diff --staged --quiet; then
            TIMESTAMP=$(date '+%Y-%m-%d %H:%M:%S')
            git commit -m "ðŸ“š Auto-update documentation: ${TIMESTAMP}
            
            - Updated README.md with current statistics
            - Refreshed workflow count and role list
            - Generated repo-stats.json"
            git push
          else
            echo "No documentation changes needed"
          fi
