name: ðŸ”§ Rule-Based Auto-Improve

on:
  schedule:
    # Every 6 hours - frequent but not aggressive
    - cron: '0 */6 * * *'
  workflow_dispatch:

permissions:
  contents: write

jobs:
  improve:
    runs-on: ubuntu-latest
    name: Apply Code Optimization Rules
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v6
        with:
          node-version: '20'
      
      - name: Apply automatic improvements
        run: |
          node -e "
          const fs = require('fs');
          
          // æ”¹å–„ãƒ«ãƒ¼ãƒ«é›†
          const improvements = [
            // 1. console.log ã‚’å‰Šé™¤ï¼ˆãƒ‘ãƒ•ã‚©ãƒ¼ãƒžãƒ³ã‚¹å‘ä¸Šï¼‰
            { 
              name: 'Remove console.log',
              pattern: /console\.log\([^)]*\);?\s*/g, 
              replace: '' 
            },
            
            // 2. var ã‚’ const/let ã«å¤‰æ›´
            { 
              name: 'Replace var with const',
              pattern: /\bvar\s+/g, 
              replace: 'const ' 
            },
            
            // 3. éžåŠ¹çŽ‡ãª for-in ãƒ«ãƒ¼ãƒ—ã‚’æœ€é©åŒ–
            { 
              name: 'Optimize Game.creeps loop',
              pattern: /for\s*\(\s*const\s+(\w+)\s+in\s+Game\.creeps\s*\)\s*{/g, 
              replace: 'for (const creep of Object.values(Game.creeps)) {' 
            },
            
            // 4. æ­»ã‚“ã ã‚¯ãƒªãƒ¼ãƒ—ã®ãƒ¡ãƒ¢ãƒªã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—ã‚’è¿½åŠ 
            {
              name: 'Add memory cleanup',
              pattern: /(module\.exports\.loop\s*=\s*function\s*\(\s*\)\s*{)/,
              replace: \`\$1
    // Auto-added: Memory cleanup
    if (!Memory.lastCleanup || Game.time - Memory.lastCleanup > 1500) {
        for (const name in Memory.creeps) {
            if (!Game.creeps[name]) {
                delete Memory.creeps[name];
            }
        }
        Memory.lastCleanup = Game.time;
    }
\`
            },
            
            // 5. undefined ãƒã‚§ãƒƒã‚¯ã‚’åŽ³å¯†ã«
            { 
              name: 'Strict undefined check',
              pattern: /if\s*\(\s*!\s*(\w+)\s*\)/g, 
              replace: 'if (\$1 === undefined || \$1 === null)' 
            }
          ];
          
          const files = fs.readdirSync('.')
            .filter(f => f.endsWith('.js') && !f.includes('node_modules'));
          
          let changedFiles = [];
          let appliedRules = [];
          
          files.forEach(file => {
            let content = fs.readFileSync(file, 'utf8');
            let original = content;
            let fileRules = [];
            
            improvements.forEach(imp => {
              const before = content;
              content = content.replace(imp.pattern, imp.replace);
              if (content !== before) {
                fileRules.push(imp.name);
              }
            });
            
            if (content !== original) {
              fs.writeFileSync(file, content);
              changedFiles.push(file);
              appliedRules.push(...fileRules);
              console.log(\`âœ… Improved: \${file} (\${fileRules.join(', ')})\`);
            }
          });
          
          if (changedFiles.length > 0) {
            const summary = {
              files: changedFiles,
              rules: [...new Set(appliedRules)],
              timestamp: new Date().toISOString()
            };
            fs.writeFileSync('last-rule-improvement.json', JSON.stringify(summary, null, 2));
            console.log(\`\nðŸŽ‰ Total improved: \${changedFiles.length} files\`);
            console.log(\`ðŸ“‹ Rules applied: \${summary.rules.join(', ')}\`);
          } else {
            console.log('âœ¨ Code already optimal!');
            process.exit(1);
          }
          "
      
      - name: Commit improvements
        run: |
          git config user.name 'Rule-Based Optimizer'
          git config user.email 'optimizer@screeps.local'
          git add *.js last-rule-improvement.json
          
          if ! git diff --staged --quiet; then
            RULES=$(node -e "console.log(require('./last-rule-improvement.json').rules.join(', '))" 2>/dev/null || echo "optimizations")
            git commit -m "ðŸ”§ Auto-improvement: Applied ${RULES}"
            git push
          else
            echo "No changes to commit"
          fi
