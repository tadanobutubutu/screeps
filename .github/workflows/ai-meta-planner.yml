name: ğŸ§  AI Meta Planner

on:
  schedule:
    # Daily at 23:45 JST (14:45 UTC) - analyzes the day and plans tomorrow
    - cron: '45 14 * * *'
  workflow_dispatch:

permissions:
  contents: write

jobs:
  meta-planning:
    runs-on: ubuntu-latest
    name: Meta Self-Improvement Planning
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: ğŸ§  Analyze and Evolve Strategy
        env:
          GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
        run: |
          node -e "
          const https = require('https');
          const fs = require('fs');

          // Load current policy
          let policy = {
            version: 1,
            complexity_level: 1,
            max_complexity: 10,
            temperature_base: 0.7,
            focus_areas: {
              performance: 20,
              new_features: 30,
              optimization: 25,
              creative: 15,
              infrastructure: 10
            },
            success_patterns: [],
            last_updated: new Date().toISOString()
          };
          
          if (fs.existsSync('ai-policy.json')) {
            policy = JSON.parse(fs.readFileSync('ai-policy.json', 'utf8'));
          }

          // Load decision history
          let decisions = [];
          if (fs.existsSync('ai-decisions.json')) {
            decisions = JSON.parse(fs.readFileSync('ai-decisions.json', 'utf8'));
          }

          let features = [];
          if (fs.existsSync('creative-features.json')) {
            features = JSON.parse(fs.readFileSync('creative-features.json', 'utf8'));
          }

          const recentDecisions = decisions.slice(-10);
          const recentFeatures = features.slice(-5);

          const prompt = \`ã‚ãªãŸã¯Screepsãƒœãƒƒãƒˆã®è‡ªå·±æ”¹å–„ã‚·ã‚¹ãƒ†ãƒ ã‚’ç®¡ç†ã™ã‚‹ãƒ¡ã‚¿AIã§ã™ã€‚éå»ã®æ”¹å–„å±¥æ­´ã‚’åˆ†æã—ã¦ã€æ˜æ—¥ä»¥é™ã®æ”¹å–„æˆ¦ç•¥ã‚’é€²åŒ–ã•ã›ã¦ãã ã•ã„ã€‚

ç¾åœ¨ã®ãƒãƒªã‚·ãƒ¼:
\${JSON.stringify(policy, null, 2)}

æœ€è¿‘ã®æ”¹å–„æ±ºå®š:
\${JSON.stringify(recentDecisions, null, 2)}

æœ€è¿‘ã®ã‚¯ãƒªã‚¨ã‚¤ãƒ†ã‚£ãƒ–æ©Ÿèƒ½:
\${JSON.stringify(recentFeatures, null, 2)}

ã‚¿ã‚¹ã‚¯:
1. éå»ã®æ”¹å–„ãƒ‘ã‚¿ãƒ¼ãƒ³ã‚’åˆ†æ
2. æˆåŠŸã—ã¦ã„ãã†ãªãƒ‘ã‚¿ãƒ¼ãƒ³ã‚’ç‰¹å®š
3. è¤‡é›‘åº¦ã‚’å°‘ã—ãšã¤ä¸Šã’ã‚‹ï¼ˆç¾åœ¨: \${policy.complexity_level}ã€æœ€å¤§: \${policy.max_complexity}ï¼‰
4. ãƒ•ã‚©ãƒ¼ã‚«ã‚¹ã‚¨ãƒªã‚¢ã®é…åˆ†ã‚’èª¿æ•´
5. æ–°ã—ã„æ”¹å–„ã‚¢ã‚¤ãƒ‡ã‚¢ã‚’ææ¡ˆ

ä»¥ä¸‹ã®JSONå½¢å¼ã§è¿”ã—ã¦ãã ã•ã„:
{
  \"analysis_summary_ja\": \"éå»ã®æ”¹å–„ã®åˆ†æçµæœï¼ˆæ—¥æœ¬èªã§è©³ã—ãï¼‰\",
  \"new_policy\": {
    \"version\": <å‰å›ã‚ˆã‚Š1å¤§ãã„æ•°å­—>,
    \"complexity_level\": <1ã‹ã‚‰10ã®é–“ã§å°‘ã—ãšã¤å¢—åŠ >,
    \"max_complexity\": 10,
    \"temperature_base\": <0.5-0.95ã®ç¯„å›²ã§èª¿æ•´>,
    \"focus_areas\": {
      \"performance\": <ãƒ‘ãƒ¼ã‚»ãƒ³ãƒ†ãƒ¼ã‚¸>,
      \"new_features\": <ãƒ‘ãƒ¼ã‚»ãƒ³ãƒ†ãƒ¼ã‚¸>,
      \"optimization\": <ãƒ‘ãƒ¼ã‚»ãƒ³ãƒ†ãƒ¼ã‚¸>,
      \"creative\": <ãƒ‘ãƒ¼ã‚»ãƒ³ãƒ†ãƒ¼ã‚¸>,
      \"infrastructure\": <ãƒ‘ãƒ¼ã‚»ãƒ³ãƒ†ãƒ¼ã‚¸>
    },
    \"success_patterns\": [\"ãƒ‘ã‚¿ãƒ¼ãƒ³1\", \"ãƒ‘ã‚¿ãƒ¼ãƒ³2\"],
    \"last_updated\": \"<ISO timestamp>\"
  },
  \"recommendations_ja\": \"æ˜æ—¥ä»¥é™ã®æ”¹å–„ã®æ¨å¥¨äº‹é …ï¼ˆæ—¥æœ¬èªã§è©³ã—ãï¼‰\",
  \"next_focus_ja\": \"æ¬¡ã«é‡ç‚¹çš„ã«å–ã‚Šçµ„ã‚€ã¹ãé ˜åŸŸï¼ˆæ—¥æœ¬èªï¼‰\"
}

åˆè¨ˆãŒ100%ã«ãªã‚‹ã‚ˆã†ã«focus_areasã‚’èª¿æ•´ã—ã¦ãã ã•ã„ã€‚\`;

          const body = JSON.stringify({
            contents: [{ parts: [{ text: prompt }] }],
            generationConfig: { temperature: 0.6, maxOutputTokens: 4096 }
          });

          const options = {
            hostname: 'generativelanguage.googleapis.com',
            path: '/v1beta/models/gemini-2.0-flash:generateContent?key=' + process.env.GEMINI_API_KEY,
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
              'Content-Length': Buffer.byteLength(body)
            }
          };

          const req = https.request(options, (res) => {
            let data = '';
            res.on('data', chunk => data += chunk);
            res.on('end', () => {
              try {
                const response = JSON.parse(data);
                const text = response.candidates[0].content.parts[0].text;
                const cleaned = text.replace(/\`\`\`json\n?/g, '').replace(/\`\`\`\n?/g, '').trim();
                const result = JSON.parse(cleaned);
                
                console.log('ğŸ§  Meta Analysis Complete');
                console.log('ğŸ“Š Analysis:', result.analysis_summary_ja);
                console.log('ğŸ¯ Next Focus:', result.next_focus_ja);
                console.log('ğŸ“ˆ New Complexity Level:', result.new_policy.complexity_level);
                
                // Save new policy
                fs.writeFileSync('ai-policy.json', JSON.stringify(result.new_policy, null, 2));
                
                // Update META-CHANGELOG.md
                const today = new Date().toISOString().split('T')[0];
                let changelog = '';
                
                if (fs.existsSync('META-CHANGELOG.md')) {
                  changelog = fs.readFileSync('META-CHANGELOG.md', 'utf8');
                }
                
                const newEntry = \`\n## \${today} - ãƒ¡ã‚¿ãƒ—ãƒ©ãƒ³ãƒ‹ãƒ³ã‚°æ›´æ–°\n\n### ğŸ“Š åˆ†æçµæœ\n\${result.analysis_summary_ja}\n\n### ğŸ¯ æ–°ã—ã„æˆ¦ç•¥\n- **è¤‡é›‘åº¦ãƒ¬ãƒ™ãƒ«**: \${result.new_policy.complexity_level}/\${result.new_policy.max_complexity}\n- **æ¸©åº¦ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿**: \${result.new_policy.temperature_base}\n- **ãƒ•ã‚©ãƒ¼ã‚«ã‚¹é…åˆ†**:\n\${Object.entries(result.new_policy.focus_areas).map(([k, v]) => \`  - \${k}: \${v}%\`).join('\n')}\n\n### ğŸ’¡ æ¨å¥¨äº‹é …\n\${result.recommendations_ja}\n\n### ğŸ”® æ¬¡ã®é‡ç‚¹é ˜åŸŸ\n\${result.next_focus_ja}\n\n---\n\`;
                
                const updatedChangelog = newEntry + changelog;
                fs.writeFileSync('META-CHANGELOG.md', updatedChangelog);
                
                console.log('âœ… Meta planning complete!');
              } catch(e) {
                console.error('Failed to parse response:', e.message);
                console.error('Raw response:', data.substring(0, 1000));
                process.exit(1);
              }
            });
          });
          req.on('error', e => { console.error(e); process.exit(1); });
          req.write(body);
          req.end();
          "

      - name: ğŸ“ Commit Meta Planning Updates
        run: |
          git config --global user.name 'AI Meta Planner'
          git config --global user.email 'meta-planner@screeps-bot.local'
          git add ai-policy.json META-CHANGELOG.md
          
          if git diff --staged --quiet; then
            echo "No changes to commit"
          else
            git commit -m "ğŸ§  Meta planning update: Strategy evolved"
            git push
          fi
