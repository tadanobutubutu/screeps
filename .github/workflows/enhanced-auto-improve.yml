name: âš¡ Enhanced Auto-Improve

on:
  schedule:
    # Every 3 hours - more frequent improvements
    - cron: '0 */3 * * *'
  workflow_dispatch:

permissions:
  contents: write

jobs:
  aggressive-improve:
    runs-on: ubuntu-latest
    name: Aggressive Code Optimization
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: âš¡ Generate Aggressive Improvements
        env:
          GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
        run: |
          node -e "
          const https = require('https');
          const fs = require('fs');

          // Read all role files
          const roles = ['harvester', 'upgrader', 'builder', 'repairer', 'scout', 'medic', 'transporter', 'explorer'];
          const currentFiles = { main: fs.readFileSync('main.js', 'utf8') };
          
          roles.forEach(role => {
            const filename = \`role.\${role}.js\`;
            if (fs.existsSync(filename)) {
              currentFiles[role] = fs.readFileSync(filename, 'utf8');
            }
          });

          const prompt = \`You are an aggressive Screeps AI optimizer. Make SIGNIFICANT improvements to the codebase. Don't be conservative - be bold!

Possible improvements:
- Add advanced pathfinding and caching
- Implement energy efficiency algorithms
- Add automatic room expansion logic
- Improve creep body composition based on room level
- Add threat detection and response
- Optimize spawn queue management
- Add resource balancing
- Implement automatic structure placement
- Add performance monitoring
- Optimize tower targeting
- Add automatic market trading

Current code:
\${JSON.stringify(currentFiles, null, 2)}

Return ONLY valid JSON with improved code for ALL files:
{
  \"main\": \"<full main.js>\",
  \"harvester\": \"<full role.harvester.js>\",
  \"upgrader\": \"<full role.upgrader.js>\",
  \"builder\": \"<full role.builder.js>\",
  \"repairer\": \"<full role.repairer.js>\",
  \"scout\": \"<full role.scout.js>\",
  \"medic\": \"<full role.medic.js>\",
  \"transporter\": \"<full role.transporter.js>\",
  \"explorer\": \"<full role.explorer.js>\",
  \"improvement_summary\": \"Brief description of main improvements made\"
}

Be aggressive and innovative!\`;

          const body = JSON.stringify({
            contents: [{ parts: [{ text: prompt }] }],
            generationConfig: { temperature: 0.8, maxOutputTokens: 16000 }
          });

          const options = {
            hostname: 'generativelanguage.googleapis.com',
            path: '/v1beta/models/gemini-2.0-flash:generateContent?key=' + process.env.GEMINI_API_KEY,
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
              'Content-Length': Buffer.byteLength(body)
            }
          };

          const req = https.request(options, (res) => {
            let data = '';
            res.on('data', chunk => data += chunk);
            res.on('end', () => {
              try {
                const response = JSON.parse(data);
                const text = response.candidates[0].content.parts[0].text;
                const cleaned = text.replace(/\`\`\`json\n?/g, '').replace(/\`\`\`\n?/g, '').trim();
                const improved = JSON.parse(cleaned);
                
                fs.writeFileSync('main.js', improved.main);
                roles.forEach(role => {
                  if (improved[role]) {
                    fs.writeFileSync(\`role.\${role}.js\`, improved[role]);
                  }
                });
                
                console.log('âš¡ Aggressive improvements applied!');
                console.log('ðŸ“ Summary:', improved.improvement_summary);
                
                // Save summary
                fs.writeFileSync('last-improvement.txt', improved.improvement_summary);
              } catch(e) {
                console.error('Failed to parse response:', e.message);
                console.error('Raw response:', data.substring(0, 1000));
                process.exit(1);
              }
            });
          });
          req.on('error', e => { console.error(e); process.exit(1); });
          req.write(body);
          req.end();
          "

      - name: Commit improvements
        run: |
          git config --global user.name 'Aggressive Optimizer'
          git config --global user.email 'optimizer@screeps-bot.local'
          git add *.js last-improvement.txt
          
          if git diff --staged --quiet; then
            echo "No changes to commit"
          else
            SUMMARY=$(cat last-improvement.txt 2>/dev/null || echo "Code optimization")
            git commit -m "âš¡ Aggressive optimization: ${SUMMARY}"
            git push
          fi
