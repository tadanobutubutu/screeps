name: 🎨 Creative Feature Generator

on:
  schedule:
    # Daily at 12:00 JST (03:00 UTC)
    - cron: '0 3 * * *'
  workflow_dispatch:

permissions:
  contents: write

jobs:
  generate-creative-feature:
    runs-on: ubuntu-latest
    name: Generate Creative New Feature
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: 🎨 Generate Creative Feature
        env:
          GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
        run: |
          node -e "
          const https = require('https');
          const fs = require('fs');

          const existingFiles = fs.readdirSync('.').filter(f => f.endsWith('.js'));

          const prompt = \`あなたは創造的なScreeps開発者です。このリポジトリにまだ存在しない、革新的で面白い新機能を考えてください。

既存ファイル: \${existingFiles.join(', ')}

クリエイティブな機能アイデア:
- role.entertainer.js - Creepがルームビジュアルでパターンやアートを描く
- role.diplomat.js - 自動同盟・外交ロジック
- role.scientist.js - 戦略を動的に研究・最適化
- utils.emoji.js - 絵文字ベースの楽しいステータス表示
- utils.music.js - コロニー状態に基づいてコンソールで「音楽」を奏でる
- role.storyteller.js - コロニーイベントの物語的な説明を生成
- utils.personality.js - Creepにユニークな個性と行動を持たせる
- role.architect.js - 自律的にベースレイアウトを設計するCreep
- utils.achievements.js - 面白いアンロック要素付きアチーブメントシステム
- role.artist.js - 部屋で視覚的なアートを作成するCreep
- utils.memes.js - ゲームイベントからミームを生成
- role.prophet.js - 将来の脅威と機会を予測

独創的で楽しく、ボットをより面白くする何かを作ってください！

以下のJSON形式で返してください:
{
  \"filename\": \"exact-filename.js\",
  \"feature_name\": \"機能名（日本語）\",
  \"description\": \"Brief English description\",
  \"description_ja\": \"この機能の詳しい日本語説明（何ができるか、どう面白いか）\",
  \"code\": \"<complete working JavaScript code>\"
}

思い切りクリエイティブに！\`;

          const body = JSON.stringify({
            contents: [{ parts: [{ text: prompt }] }],
            generationConfig: { temperature: 0.95, maxOutputTokens: 8192 }
          });

          const options = {
            hostname: 'generativelanguage.googleapis.com',
            path: '/v1beta/models/gemini-2.0-flash:generateContent?key=' + process.env.GEMINI_API_KEY,
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
              'Content-Length': Buffer.byteLength(body)
            }
          };

          const req = https.request(options, (res) => {
            let data = '';
            res.on('data', chunk => data += chunk);
            res.on('end', () => {
              try {
                const response = JSON.parse(data);
                const text = response.candidates[0].content.parts[0].text;
                const cleaned = text.replace(/\`\`\`json\n?/g, '').replace(/\`\`\`\n?/g, '').trim();
                const feature = JSON.parse(cleaned);
                
                console.log('🎨 Creative Feature:', feature.feature_name);
                console.log('📝 Description:', feature.description_ja);
                console.log('📄 Filename:', feature.filename);
                
                fs.writeFileSync(feature.filename, feature.code);
                
                const logEntry = {
                  timestamp: new Date().toISOString(),
                  name: feature.feature_name,
                  filename: feature.filename,
                  description: feature.description,
                  description_ja: feature.description_ja
                };
                
                let log = [];
                if (fs.existsSync('creative-features.json')) {
                  log = JSON.parse(fs.readFileSync('creative-features.json', 'utf8'));
                }
                log.push(logEntry);
                fs.writeFileSync('creative-features.json', JSON.stringify(log, null, 2));
                
                // Update META-CHANGELOG
                const today = new Date().toISOString().split('T')[0];
                let changelog = '';
                if (fs.existsSync('META-CHANGELOG.md')) {
                  changelog = fs.readFileSync('META-CHANGELOG.md', 'utf8');
                }
                
                const timeStr = new Date().toLocaleTimeString('ja-JP', { timeZone: 'Asia/Tokyo', hour: '2-digit', minute: '2-digit' });
                const entry = \`\n### \${timeStr} - 🎨 クリエイティブ新機能\n\n**ファイル**: \\`\${feature.filename}\\`  \n**機能名**: \${feature.feature_name}\n\n**説明**:  \n\${feature.description_ja}\n\`;
                
                if (changelog.includes(\`## \${today}\`)) {
                  changelog = changelog.replace(\`## \${today}\`, \`## \${today}\${entry}\`);
                } else {
                  changelog = \`## \${today}\n\${entry}\n\${changelog}\`;
                }
                
                fs.writeFileSync('META-CHANGELOG.md', changelog);
                
                console.log('✨ Creative feature generated!');
              } catch(e) {
                console.error('Failed to parse response:', e.message);
                console.error('Raw response:', data.substring(0, 500));
                process.exit(1);
              }
            });
          });
          req.on('error', e => { console.error(e); process.exit(1); });
          req.write(body);
          req.end();
          "

      - name: 📝 Commit Creative Feature
        run: |
          git config --global user.name 'Creative Feature Bot'
          git config --global user.email 'creative@screeps-bot.local'
          git add -A
          
          if git diff --staged --quiet; then
            echo "No new feature to commit"
          else
            FEATURE=$(node -e "const log = require('./creative-features.json'); console.log(log[log.length-1].name);" 2>/dev/null || echo "New feature")
            git commit -m "🎨 ${FEATURE}"
            git push
          fi
