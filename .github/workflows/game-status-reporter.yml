name: ğŸ“Š Game Status Reporter

on:
  schedule:
    # Every hour
    - cron: '0 * * * *'
  workflow_dispatch:

permissions:
  contents: write

jobs:
  report-game-status:
    runs-on: ubuntu-latest
    name: Fetch and Report Game Status
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
      
      - name: Fetch game status from Screeps API
        env:
          SCREEPS_TOKEN: ${{ secrets.SCREEPS_TOKEN }}
        run: |
          node -e "
          const https = require('https');
          const fs = require('fs');
          
          const token = process.env.SCREEPS_TOKEN;
          if (!token) {
            console.log('âš ï¸ SCREEPS_TOKEN not set, skipping...');
            process.exit(0);
          }
          
          function apiCall(path) {
            return new Promise((resolve, reject) => {
              const options = {
                hostname: 'screeps.com',
                port: 443,
                path: path,
                method: 'GET',
                headers: { 'X-Token': token }
              };
              
              const req = https.request(options, (res) => {
                let data = '';
                res.on('data', chunk => data += chunk);
                res.on('end', () => {
                  try {
                    resolve(JSON.parse(data));
                  } catch(e) {
                    reject(e);
                  }
                });
              });
              req.on('error', reject);
              req.setTimeout(10000, () => {
                req.destroy();
                reject(new Error('Timeout'));
              });
              req.end();
            });
          }
          
          (async () => {
            try {
              console.log('ğŸ” Fetching game data...');
              
              // ãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ±
              const user = await apiCall('/api/auth/me');
              console.log('âœ… User data fetched');
              
              // æ‰€æœ‰ã—ã¦ã„ã‚‹éƒ¨å±‹ã®ãƒªã‚¹ãƒˆ
              const rooms = await apiCall('/api/user/rooms');
              console.log('âœ… Room data fetched');
              
              // ãƒ¡ãƒ¢ãƒªæƒ…å ±
              const memory = await apiCall('/api/user/memory');
              console.log('âœ… Memory data fetched');
              
              // ç¾åœ¨æ™‚åˆ»
              const now = new Date();
              const timestamp = now.toISOString();
              const dateStr = now.toISOString().split('T')[0];
              const timeStr = now.toTimeString().split(' ')[0];
              
              // ãƒ¬ãƒãƒ¼ãƒˆä½œæˆ
              let report = \`# ğŸ® Screeps Game Status Report\n\n\`;
              report += \`**æ›´æ–°æ—¥æ™‚**: \${timestamp} (JST: \${new Date(now.getTime() + 9*60*60*1000).toISOString().replace('T', ' ').slice(0, 19)})\n\n\`;
              report += \`---\n\n\`;
              
              // ãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ±
              report += \`## ğŸ‘¤ ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼æƒ…å ±\n\n\`;
              report += \`- **ãƒ¦ãƒ¼ã‚¶ãƒ¼å**: \${user.username || 'N/A'}\n\`;
              report += \`- **GCL**: \${user.gcl ? Math.floor(user.gcl) : 'N/A'}\n\`;
              report += \`- **CPUåˆ¶é™**: \${user.cpu || 'N/A'}\n\`;
              report += \`- **Credits**: \${user.money || 0}\n\n\`;
              
              // éƒ¨å±‹æƒ…å ±
              if (rooms && rooms.rooms && rooms.rooms.length > 0) {
                report += \`## ğŸ° æ‰€æœ‰éƒ¨å±‹ (\${rooms.rooms.length}éƒ¨å±‹)\n\n\`;
                
                rooms.rooms.forEach(room => {
                  report += \`### éƒ¨å±‹: \${room.name || room}\n\n\`;
                  if (typeof room === 'object') {
                    report += \`- **RCL**: \${room.level || 'N/A'}\n\`;
                    report += \`- **ã‚¨ãƒãƒ«ã‚®ãƒ¼**: \${room.energyAvailable || 0} / \${room.energyCapacityAvailable || 0}\n\`;
                  }
                  report += \`\n\`;
                });
              } else {
                report += \`## ğŸ° æ‰€æœ‰éƒ¨å±‹\n\n\`;
                report += \`*ã¾ã éƒ¨å±‹ã‚’æ‰€æœ‰ã—ã¦ã„ã¾ã›ã‚“*\n\n\`;
              }
              
              // ãƒ¡ãƒ¢ãƒªçµ±è¨ˆ
              if (memory && memory.data) {
                report += \`## ğŸ’¾ ãƒ¡ãƒ¢ãƒªçµ±è¨ˆ\n\n\`;
                const memStr = JSON.stringify(memory.data);
                const memSize = memStr.length;
                const memLimit = 2048 * 1024;
                const memPercent = ((memSize / memLimit) * 100).toFixed(2);
                
                report += \`- **ä½¿ç”¨é‡**: \${(memSize / 1024).toFixed(2)} KB / \${(memLimit / 1024).toFixed(2)} KB (\${memPercent}%)\n\`;
                
                // ã‚¯ãƒªãƒ¼ãƒ—æ•°
                if (memory.data.creeps) {
                  const creepCount = Object.keys(memory.data.creeps).length;
                  report += \`- **ã‚¯ãƒªãƒ¼ãƒ—æ•°**: \${creepCount}\n\`;
                  
                  // ãƒ­ãƒ¼ãƒ«åˆ¥é›†è¨ˆ
                  const roleCount = {};
                  Object.values(memory.data.creeps).forEach(creep => {
                    const role = creep.role || 'unknown';
                    roleCount[role] = (roleCount[role] || 0) + 1;
                  });
                  
                  if (Object.keys(roleCount).length > 0) {
                    report += \`\n**ãƒ­ãƒ¼ãƒ«åˆ¥å†…è¨³**:\n\`;
                    Object.entries(roleCount).sort((a, b) => b[1] - a[1]).forEach(([role, count]) => {
                      report += \`  - \${role}: \${count}\n\`;
                    });
                  }
                }
                
                report += \`\n\`;
              }
              
              // ãƒ•ãƒƒã‚¿ãƒ¼
              report += \`---\n\n\`;
              report += \`*ã“ã®ãƒ¬ãƒãƒ¼ãƒˆã¯è‡ªå‹•ç”Ÿæˆã•ã‚Œã¦ã„ã¾ã™ï¼ˆæ¯æ™‚æ›´æ–°ï¼‰*\n\`;
              report += \`*æœ€çµ‚æ›´æ–°: \${timestamp}*\n\`;
              
              // ãƒ•ã‚¡ã‚¤ãƒ«ã«ä¿å­˜
              fs.writeFileSync('GAME_STATUS.md', report);
              console.log('âœ… Report saved to GAME_STATUS.md');
              
              // å±¥æ­´ãƒ•ã‚¡ã‚¤ãƒ«ã‚‚ä½œæˆï¼ˆæ—¥ä»˜ã”ã¨ï¼‰
              const historyDir = 'game-history';
              if (!fs.existsSync(historyDir)) {
                fs.mkdirSync(historyDir);
              }
              
              const historyFile = \`\${historyDir}/\${dateStr}.md\`;
              let historyContent = '';
              
              if (fs.existsSync(historyFile)) {
                historyContent = fs.readFileSync(historyFile, 'utf8');
              } else {
                historyContent = \`# ğŸ“… \${dateStr} ã®ã‚²ãƒ¼ãƒ å±¥æ­´\n\n\`;
              }
              
              historyContent += \`\n## â° \${timeStr}\n\n\`;
              historyContent += \`- GCL: \${user.gcl ? Math.floor(user.gcl) : 'N/A'}\n\`;
              historyContent += \`- CPU: \${user.cpu || 'N/A'}\n\`;
              historyContent += \`- éƒ¨å±‹æ•°: \${rooms.rooms ? rooms.rooms.length : 0}\n\`;
              if (memory && memory.data && memory.data.creeps) {
                historyContent += \`- ã‚¯ãƒªãƒ¼ãƒ—æ•°: \${Object.keys(memory.data.creeps).length}\n\`;
              }
              historyContent += \`\n\`;
              
              fs.writeFileSync(historyFile, historyContent);
              console.log(\`âœ… History saved to \${historyFile}\`);
              
            } catch(e) {
              console.error('âŒ Error fetching game data:', e.message);
              
              // ã‚¨ãƒ©ãƒ¼ã§ã‚‚æœ€ä½é™ã®ãƒ¬ãƒãƒ¼ãƒˆã‚’ä½œæˆ
              const errorReport = \`# ğŸ® Screeps Game Status Report\n\n**Status**: âš ï¸ ãƒ‡ãƒ¼ã‚¿å–å¾—ã‚¨ãƒ©ãƒ¼\n\n**ã‚¨ãƒ©ãƒ¼**: \${e.message}\n\n*è³¼å…¥å‰ã€ã¾ãŸã¯ãƒˆãƒ¼ã‚¯ãƒ³ãŒç„¡åŠ¹ãªå¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™*\n\`;
              fs.writeFileSync('GAME_STATUS.md', errorReport);
              process.exit(0); // ã‚¨ãƒ©ãƒ¼ã§ã‚‚æˆåŠŸæ‰±ã„ã«ã—ã¦ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ã‚’ç¶™ç¶š
            }
          })();
          "
      
      - name: Commit game status
        run: |
          git config user.name 'Game Status Bot'
          git config user.email 'status@screeps.local'
          git add GAME_STATUS.md game-history/
          
          if ! git diff --staged --quiet; then
            TIMESTAMP=$(date '+%Y-%m-%d %H:%M:%S')
            git commit -m "ğŸ“Š Game status update: ${TIMESTAMP}
            
            Automated hourly game status report"
            git push
          else
            echo "No changes in game status"
          fi
