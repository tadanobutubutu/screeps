name: üõ°Ô∏è Prevent Null/Undefined Errors

on:
  push:
    paths:
      - '**.js'
  pull_request:
    paths:
      - '**.js'
  schedule:
    - cron: '0 0 * * 0'  # Weekly on Sunday

permissions:
  contents: read

jobs:
  check-null-safety:
    runs-on: ubuntu-latest
    name: Check Null Safety
    
    steps:
      - uses: actions/checkout@v6
      
      - name: Scan for Common Null/Undefined Issues
        run: |
          echo "üîç Scanning for potential null/undefined errors..."
          
          ISSUES_FOUND=0
          
          # Check for Object.keys() without null check
          echo "\n‚ö†Ô∏è Checking Object.keys() usage..."
          if find . -name '*.js' -not -path './node_modules/*' -not -path './.git/*' -exec grep -l "Object.keys(" {} \; | head -10; then
            echo "‚ö†Ô∏è Found Object.keys() usage - verify null checks exist"
            ISSUES_FOUND=$((ISSUES_FOUND + 1))
          else
            echo "‚úÖ Object.keys() usage looks safe"
          fi
          
          # Check for Game.map.describeExits() usage
          echo "\n‚ö†Ô∏è Checking Game.map.describeExits() usage..."
          if find . -name '*.js' -not -path './node_modules/*' -not -path './.git/*' -exec grep -l "Game.map.describeExits" {} \; | head -10; then
            echo "‚ö†Ô∏è Found Game.map.describeExits() - verify null checks exist"
          else
            echo "‚úÖ Game.map.describeExits() usage looks safe"
          fi
          
          # Generate report
          cat > NULL_SAFETY_REPORT.md << 'EOF'
          # üõ°Ô∏è Null Safety Report
          
          **Generated**: $(date -u +%Y-%m-%dT%H:%M:%SZ)
          
          ## üìä Summary
          
          This is an automated check for common null/undefined errors.
          
          ## ‚úÖ Checked Patterns
          
          1. **Object.keys()** - Should check if object exists first
          2. **Game.map.describeExits()** - Can return null
          3. **Array access [0]** - Should check length first
          4. **Property access** - Should use optional chaining
          
          ## üìù Best Practices
          
          ### Safe Object.keys() usage
          ```javascript
          // Bad
          const keys = Object.keys(exits);
          
          // Good
          if (exits && Object.keys(exits).length > 0) {
            const keys = Object.keys(exits);
          }
          ```
          
          ### Safe Game.map usage
          ```javascript
          // Bad
          const exits = Game.map.describeExits(roomName);
          const first = Object.keys(exits)[0];
          
          // Good
          const exits = Game.map.describeExits(roomName);
          if (exits && Object.keys(exits).length > 0) {
            const first = Object.keys(exits)[0];
          }
          ```
          
          ## üêõ Recent Fixes
          
          - Fixed explorer role null check (2026-02-25)
          
          EOF
          
          echo "\n‚úÖ Scan complete"
          
          if [ $ISSUES_FOUND -gt 0 ]; then
            echo "‚ö†Ô∏è Found $ISSUES_FOUND potential issues"
            echo "Please review the code and add null checks where needed"
          else
            echo "‚úÖ No issues found"
          fi
