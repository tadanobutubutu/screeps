name: üé® Creative Feature Generator

on:
  schedule:
    # Daily at 12:00 JST (03:00 UTC)
    - cron: '0 3 * * *'
  workflow_dispatch:

permissions:
  contents: write

jobs:
  generate-creative-feature:
    runs-on: ubuntu-latest
    name: Generate Creative New Feature
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: üé® Generate Creative Feature
        env:
          GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
        run: |
          node -e "
          const https = require('https');
          const fs = require('fs');

          const existingFiles = fs.readdirSync('.').filter(f => f.endsWith('.js'));

          const prompt = \`You are a creative Screeps developer. Come up with an INNOVATIVE and FUN new feature that doesn't exist yet in this repository.

Existing files: \${existingFiles.join(', ')}

Creative feature ideas:
- role.entertainer.js - Creeps that draw patterns and art with room visuals
- role.diplomat.js - Automated alliance and diplomacy logic
- role.scientist.js - Research and optimize strategies dynamically
- utils.emoji.js - Fun emoji-based status indicators
- utils.music.js - Play \"music\" through console logs based on colony state
- role.storyteller.js - Generate narrative descriptions of colony events
- utils.personality.js - Give creeps unique personalities and behaviors
- role.architect.js - Creeps that autonomously design base layouts
- utils.achievements.js - Achievement system with fun unlockables
- role.artist.js - Creeps that create visual art in the room
- utils.memes.js - Generate memes based on game events
- role.prophet.js - Predict future threats and opportunities

Create something UNIQUE, FUN, and CREATIVE that makes the bot more interesting!

Return ONLY valid JSON:
{
  \"filename\": \"exact-filename.js\",
  \"feature_name\": \"Cool Feature Name\",
  \"description\": \"What this feature does\",
  \"code\": \"<complete working JavaScript code>\"
}

Be wildly creative!\`;

          const body = JSON.stringify({
            contents: [{ parts: [{ text: prompt }] }],
            generationConfig: { temperature: 0.95, maxOutputTokens: 8192 }
          });

          const options = {
            hostname: 'generativelanguage.googleapis.com',
            path: '/v1beta/models/gemini-2.0-flash:generateContent?key=' + process.env.GEMINI_API_KEY,
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
              'Content-Length': Buffer.byteLength(body)
            }
          };

          const req = https.request(options, (res) => {
            let data = '';
            res.on('data', chunk => data += chunk);
            res.on('end', () => {
              try {
                const response = JSON.parse(data);
                const text = response.candidates[0].content.parts[0].text;
                const cleaned = text.replace(/\`\`\`json\n?/g, '').replace(/\`\`\`\n?/g, '').trim();
                const feature = JSON.parse(cleaned);
                
                console.log('üé® Creative Feature:', feature.feature_name);
                console.log('üìù Description:', feature.description);
                console.log('üìÑ Filename:', feature.filename);
                
                fs.writeFileSync(feature.filename, feature.code);
                
                // Update feature log
                const logEntry = {
                  timestamp: new Date().toISOString(),
                  name: feature.feature_name,
                  filename: feature.filename,
                  description: feature.description
                };
                
                let log = [];
                if (fs.existsSync('creative-features.json')) {
                  log = JSON.parse(fs.readFileSync('creative-features.json', 'utf8'));
                }
                log.push(logEntry);
                fs.writeFileSync('creative-features.json', JSON.stringify(log, null, 2));
                
                console.log('‚ú® Creative feature generated!');
              } catch(e) {
                console.error('Failed to parse response:', e.message);
                console.error('Raw response:', data.substring(0, 500));
                process.exit(1);
              }
            });
          });
          req.on('error', e => { console.error(e); process.exit(1); });
          req.write(body);
          req.end();
          "

      - name: üìù Commit Creative Feature
        run: |
          git config --global user.name 'Creative Feature Bot'
          git config --global user.email 'creative@screeps-bot.local'
          git add -A
          
          if git diff --staged --quiet; then
            echo "No new feature to commit"
          else
            FEATURE=$(node -e "const log = require('./creative-features.json'); console.log(log[log.length-1].name);")
            git commit -m "üé® New creative feature: ${FEATURE}"
            git push
          fi
