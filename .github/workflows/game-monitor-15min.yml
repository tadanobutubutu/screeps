name: ‚è±Ô∏è Game Monitor (GitHub Sync)

on:
  schedule:
    - cron: '*/15 * * * *'
  workflow_dispatch:

permissions:
  contents: write
  issues: write

jobs:
  monitor-via-sync:
    runs-on: ubuntu-latest
    name: Monitor via GitHub Sync (No API)
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      
      - name: Check if using GitHub Sync
        id: check
        run: |
          echo "üì° GitHub Sync Mode Enabled"
          echo "‚ÑπÔ∏è  Game auto-syncs from this repository"
          echo "‚ÑπÔ∏è  No API calls needed - fully integrated!"
          
          # Check if we have any error reports from game
          if [ -f "DETECTED_ERRORS.json" ]; then
            echo "has_errors=true" >> $GITHUB_OUTPUT
            echo "‚ö†Ô∏è Error report found from previous run"
          else
            echo "has_errors=false" >> $GITHUB_OUTPUT
            echo "‚úÖ No errors detected"
          fi
      
      - name: Update Status (Sync Mode)
        run: |
          cat > GAME_STATUS.md << 'EOF'
          # üéÆ Game Status (GitHub Sync Mode)
          
          **Updated**: $(date -u +%Y-%m-%dT%H:%M:%SZ)
          **Mode**: GitHub Sync (API-free) ‚úÖ
          
          ---
          
          ## üîó GitHub Integration
          
          This repository uses **Screeps GitHub Integration**:
          
          - ‚úÖ **Auto-sync enabled**: Every push automatically deploys
          - ‚úÖ **No API tokens needed**: Direct integration
          - ‚úÖ **Zero cost**: Completely free
          - ‚úÖ **Real-time**: Changes reflect immediately
          
          ## üìä How to Check Game Status
          
          ### In Screeps Console:
          ```javascript
          // Check current stats
          Game.time
          Game.gcl.level
          Object.keys(Game.creeps).length
          
          // Check errors
          Memory.logs.filter(l => l.level === 'error')
          
          // Get role counts
          const roles = {};
          for (let name in Game.creeps) {
            const role = Game.creeps[name].memory.role;
            roles[role] = (roles[role] || 0) + 1;
          }
          console.log(JSON.stringify(roles));
          ```
          
          ## üîÑ Current System Status
          
          - **Deployment**: GitHub Sync Active
          - **Error Detection**: In-game logging to Memory.logs
          - **Auto-Fix**: Monitors Memory.logs for errors
          - **Code Quality**: Auto-formatting on push
          - **Security**: Daily scans
          
          ## üêõ Error Reporting
          
          Errors are automatically logged to `Memory.logs` in-game.
          
          To report errors to GitHub:
          1. Errors are logged with `logger.error()`
          2. Stored in `Memory.logs`
          3. Auto-fix system analyzes patterns
          4. PRs created for fixes
          
          ## üìù Console Logs
          
          Since we use GitHub Sync mode, console logs are:
          - Stored in-game in `Memory.logs`
          - Accessible via Screeps console
          - Auto-fix monitors them for errors
          
          **View logs in Screeps Console**:
          ```javascript
          Memory.logs.slice(-10).forEach(l => 
            console.log(`[${l.level}] ${l.message}`)
          )
          ```
          
          ---
          
          *This repository uses GitHub Sync - No API tokens required!*
          *Last checked: $(date -u +%Y-%m-%dT%H:%M:%SZ)*
          EOF
          
          echo "‚úÖ Status page updated for GitHub Sync mode"
      
      - name: Trigger Auto-Fix if Needed
        if: steps.check.outputs.has_errors == 'true'
        run: |
          echo "üîß Errors detected - triggering auto-fix"
          gh workflow run auto-fix-errors.yml || echo "Auto-fix will run on next schedule"
        env:
          GH_TOKEN: ${{ github.token }}
      
      - name: Commit Status Update
        run: |
          git config user.name 'Sync Monitor Bot'
          git config user.email 'sync@screeps.local'
          git add GAME_STATUS.md
          
          if ! git diff --staged --quiet; then
            git commit -m "‚è±Ô∏è Status check: $(date '+%Y-%m-%d %H:%M')
            
            GitHub Sync mode - No API needed"
            git push
          else
            echo "No status changes"
          fi
