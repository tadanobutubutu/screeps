name: ğŸ® Project Gamification

on:
  issues:
    types: [opened, closed, labeled]
  pull_request:
    types: [opened, closed, merged]
  push:
    branches: [main]

permissions:
  contents: write
  issues: write
  pull-requests: write

jobs:
  gamification:
    runs-on: ubuntu-latest
    name: Update Achievements & Stats
    
    steps:
      - name: Checkout
        uses: actions/checkout@v6
      
      - name: Calculate Stats
        id: stats
        run: |
          echo "ğŸ“Š Calculating project stats..."
          
          # Get total issues
          TOTAL_ISSUES=$(gh issue list --limit 1000 --json number | jq 'length')
          CLOSED_ISSUES=$(gh issue list --state closed --limit 1000 --json number | jq 'length')
          OPEN_ISSUES=$(gh issue list --state open --limit 1000 --json number | jq 'length')
          
          # Get PRs
          TOTAL_PRS=$(gh pr list --limit 1000 --json number | jq 'length')
          MERGED_PRS=$(gh pr list --state merged --limit 1000 --json number | jq 'length')
          
          # Calculate completion rate
          if [ $TOTAL_ISSUES -gt 0 ]; then
            COMPLETION_RATE=$((CLOSED_ISSUES * 100 / TOTAL_ISSUES))
          else
            COMPLETION_RATE=0
          fi
          
          # Get contributor count
          CONTRIBUTORS=$(gh api repos/${{ github.repository }}/contributors | jq 'length')
          
          # Get commit count
          COMMITS=$(gh api repos/${{ github.repository }}/commits --paginate | jq -s 'length')
          
          echo "total_issues=$TOTAL_ISSUES" >> $GITHUB_OUTPUT
          echo "closed_issues=$CLOSED_ISSUES" >> $GITHUB_OUTPUT
          echo "open_issues=$OPEN_ISSUES" >> $GITHUB_OUTPUT
          echo "completion_rate=$COMPLETION_RATE" >> $GITHUB_OUTPUT
          echo "total_prs=$TOTAL_PRS" >> $GITHUB_OUTPUT
          echo "merged_prs=$MERGED_PRS" >> $GITHUB_OUTPUT
          echo "contributors=$CONTRIBUTORS" >> $GITHUB_OUTPUT
          echo "commits=$COMMITS" >> $GITHUB_OUTPUT
          
          echo "âœ… Stats calculated!"
        env:
          GH_TOKEN: ${{ github.token }}
      
      - name: Check Achievements
        id: achievements
        run: |
          echo "ğŸ† Checking achievements..."
          
          ACHIEVEMENTS=""
          
          # Issue-based achievements
          if [ ${{ steps.stats.outputs.closed_issues }} -ge 1 ]; then
            ACHIEVEMENTS="$ACHIEVEMENTS\nğŸ¯ First Blood - Closed first issue"
          fi
          
          if [ ${{ steps.stats.outputs.closed_issues }} -ge 10 ]; then
            ACHIEVEMENTS="$ACHIEVEMENTS\nâ­ Issue Hunter - Closed 10 issues"
          fi
          
          if [ ${{ steps.stats.outputs.closed_issues }} -ge 50 ]; then
            ACHIEVEMENTS="$ACHIEVEMENTS\nğŸ… Issue Master - Closed 50 issues"
          fi
          
          if [ ${{ steps.stats.outputs.closed_issues }} -ge 100 ]; then
            ACHIEVEMENTS="$ACHIEVEMENTS\nğŸ‘‘ Issue Legend - Closed 100 issues"
          fi
          
          # PR-based achievements
          if [ ${{ steps.stats.outputs.merged_prs }} -ge 1 ]; then
            ACHIEVEMENTS="$ACHIEVEMENTS\nğŸš€ First Flight - Merged first PR"
          fi
          
          if [ ${{ steps.stats.outputs.merged_prs }} -ge 10 ]; then
            ACHIEVEMENTS="$ACHIEVEMENTS\nğŸ’ PR Pro - Merged 10 PRs"
          fi
          
          if [ ${{ steps.stats.outputs.merged_prs }} -ge 50 ]; then
            ACHIEVEMENTS="$ACHIEVEMENTS\nğŸŒŸ Merge Wizard - Merged 50 PRs"
          fi
          
          # Commit-based achievements
          if [ ${{ steps.stats.outputs.commits }} -ge 100 ]; then
            ACHIEVEMENTS="$ACHIEVEMENTS\nğŸ”¥ Commit Streak - 100 commits"
          fi
          
          if [ ${{ steps.stats.outputs.commits }} -ge 500 ]; then
            ACHIEVEMENTS="$ACHIEVEMENTS\nğŸ’ª Code Warrior - 500 commits"
          fi
          
          # Completion rate achievements
          if [ ${{ steps.stats.outputs.completion_rate }} -ge 80 ]; then
            ACHIEVEMENTS="$ACHIEVEMENTS\nâœ¨ Perfectionist - 80% completion rate"
          fi
          
          # Team achievements
          if [ ${{ steps.stats.outputs.contributors }} -ge 5 ]; then
            ACHIEVEMENTS="$ACHIEVEMENTS\nğŸ¤ Team Builder - 5+ contributors"
          fi
          
          echo "achievements<<EOF" >> $GITHUB_OUTPUT
          echo -e "$ACHIEVEMENTS" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT
      
      - name: Determine Level
        id: level
        run: |
          TOTAL_POINTS=$(( ${{ steps.stats.outputs.closed_issues }} * 10 + ${{ steps.stats.outputs.merged_prs }} * 20 + ${{ steps.stats.outputs.commits }} ))
          
          if [ $TOTAL_POINTS -lt 100 ]; then
            LEVEL="ğŸŒ± Newbie"
            LEVEL_NUM=1
          elif [ $TOTAL_POINTS -lt 500 ]; then
            LEVEL="ğŸ”° Beginner"
            LEVEL_NUM=2
          elif [ $TOTAL_POINTS -lt 1000 ]; then
            LEVEL="âš¡ Intermediate"
            LEVEL_NUM=3
          elif [ $TOTAL_POINTS -lt 5000 ]; then
            LEVEL="ğŸŒŸ Advanced"
            LEVEL_NUM=4
          elif [ $TOTAL_POINTS -lt 10000 ]; then
            LEVEL="ğŸ’ Expert"
            LEVEL_NUM=5
          else
            LEVEL="ğŸ‘‘ Master"
            LEVEL_NUM=6
          fi
          
          echo "level=$LEVEL" >> $GITHUB_OUTPUT
          echo "level_num=$LEVEL_NUM" >> $GITHUB_OUTPUT
          echo "total_points=$TOTAL_POINTS" >> $GITHUB_OUTPUT
      
      - name: Generate Progress Bar
        id: progress
        run: |
          COMPLETION=${{ steps.stats.outputs.completion_rate }}
          FILLED=$((COMPLETION / 5))
          EMPTY=$((20 - FILLED))
          
          BAR="["
          for i in $(seq 1 $FILLED); do BAR="${BAR}â–ˆ"; done
          for i in $(seq 1 $EMPTY); do BAR="${BAR}â–‘"; done
          BAR="${BAR}]"
          
          echo "bar=$BAR" >> $GITHUB_OUTPUT
      
      - name: Create Stats Dashboard
        run: |
          cat > GAME_STATS.md << 'EOF'
          # ğŸ® Project Game Stats
          
          **Last Updated**: $(date -u '+%Y-%m-%d %H:%M:%S UTC')
          
          ## ğŸ“Š Current Status
          
          ### Level & Points
          - **Level**: ${{ steps.level.outputs.level }} (Level ${{ steps.level.outputs.level_num }})
          - **Total Points**: ${{ steps.level.outputs.total_points }}
          
          ### Project Stats
          - **Total Issues**: ${{ steps.stats.outputs.total_issues }}
            - âœ… Closed: ${{ steps.stats.outputs.closed_issues }}
            - ğŸ”„ Open: ${{ steps.stats.outputs.open_issues }}
          - **Total PRs**: ${{ steps.stats.outputs.total_prs }}
            - âœ… Merged: ${{ steps.stats.outputs.merged_prs }}
          - **Total Commits**: ${{ steps.stats.outputs.commits }}
          - **Contributors**: ${{ steps.stats.outputs.contributors }}
          
          ### Completion Rate
          ${{ steps.progress.outputs.bar }} ${{ steps.stats.outputs.completion_rate }}%
          
          ## ğŸ† Achievements Unlocked
          
          ${{ steps.achievements.outputs.achievements }}
          
          ## ğŸ“ˆ Points System
          
          - Close Issue: **10 points** ğŸ¯
          - Merge PR: **20 points** ğŸš€
          - Commit: **1 point** ğŸ’»
          
          ## ğŸšï¸ Level System
          
          1. ğŸŒ± **Newbie** (0-99 points)
          2. ğŸ”° **Beginner** (100-499 points)
          3. âš¡ **Intermediate** (500-999 points)
          4. ğŸŒŸ **Advanced** (1,000-4,999 points)
          5. ğŸ’ **Expert** (5,000-9,999 points)
          6. ğŸ‘‘ **Master** (10,000+ points)
          
          ## ğŸ¯ Next Milestone
          
          $(if [ ${{ steps.stats.outputs.closed_issues }} -lt 10 ]; then echo "- Close $(( 10 - ${{ steps.stats.outputs.closed_issues }} )) more issues to unlock â­ Issue Hunter"; fi)
          $(if [ ${{ steps.stats.outputs.merged_prs }} -lt 10 ]; then echo "- Merge $(( 10 - ${{ steps.stats.outputs.merged_prs }} )) more PRs to unlock ğŸ’ PR Pro"; fi)
          $(if [ ${{ steps.stats.outputs.completion_rate }} -lt 80 ]; then echo "- Reach $(( 80 - ${{ steps.stats.outputs.completion_rate }} ))% more completion for âœ¨ Perfectionist"; fi)
          
          ---
          
          *Auto-updated by Project Gamification System ğŸ®*
          EOF
          
          echo "âœ… Dashboard created!"
      
      - name: Commit Stats
        run: |
          git config user.name 'Game Stats Bot'
          git config user.email 'stats@screeps.bot'
          git add GAME_STATS.md
          git commit -m "ğŸ® Update game stats [skip ci]" || echo "No changes"
          git push || echo "Nothing to push"
      
      - name: Celebrate Milestones
        if: |
          steps.stats.outputs.closed_issues == '10' || 
          steps.stats.outputs.closed_issues == '50' ||
          steps.stats.outputs.merged_prs == '10'
        run: |
          echo "ğŸ‰ MILESTONE REACHED! ğŸ‰"
          echo "ğŸŠ Congratulations on this achievement!"
          
          # Create celebration issue
          gh issue create \
            --title "ğŸ‰ Milestone Achievement Unlocked!" \
            --body "## ğŸŠ Congratulations!
          
          You've reached an amazing milestone:
          
          - **Closed Issues**: ${{ steps.stats.outputs.closed_issues }}
          - **Merged PRs**: ${{ steps.stats.outputs.merged_prs }}
          - **Level**: ${{ steps.level.outputs.level }}
          
          Keep up the great work! ğŸš€
          
          ${{ steps.achievements.outputs.achievements }}" \
            --label "celebration,milestone"
        env:
          GH_TOKEN: ${{ github.token }}
