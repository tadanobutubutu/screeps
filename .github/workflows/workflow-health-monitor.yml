name: ğŸ”§ Workflow Health Monitor

on:
  schedule:
    - cron: '0 */6 * * *'  # Every 6 hours
  workflow_dispatch:
  workflow_run:
    workflows: ["*"]
    types:
      - completed

permissions:
  contents: write
  actions: write
  issues: write
  pull-requests: write

jobs:
  check-workflow-health:
    runs-on: ubuntu-latest
    name: Check & Fix Workflow Issues
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      
      - name: Analyze Recent Workflow Runs
        id: analyze
        run: |
          echo "ğŸ” Analyzing recent workflow runs..."
          
          # Get failed workflows from last 24 hours
          FAILED_RUNS=$(gh run list --limit 50 --json status,conclusion,name,createdAt,databaseId,workflowName | \
            jq -r '[.[] | select(.conclusion == "failure" or .conclusion == "cancelled")] | length')
          
          echo "failed_count=$FAILED_RUNS" >> $GITHUB_OUTPUT
          echo "ğŸ“Š Found $FAILED_RUNS failed/cancelled runs in last 50"
          
          # Get detailed info about failures
          gh run list --limit 50 --json status,conclusion,name,createdAt,databaseId,workflowName | \
            jq '[.[] | select(.conclusion == "failure" or .conclusion == "cancelled") | {workflow: .workflowName, name: .name, id: .databaseId, created: .createdAt}]' > failed_workflows.json
          
          if [ $FAILED_RUNS -gt 0 ]; then
            echo "has_failures=true" >> $GITHUB_OUTPUT
            echo "âš ï¸ Workflow failures detected!"
            cat failed_workflows.json
          else
            echo "has_failures=false" >> $GITHUB_OUTPUT
            echo "âœ… All workflows healthy"
          fi
        env:
          GH_TOKEN: ${{ github.token }}
      
      - name: Get Failure Details
        if: steps.analyze.outputs.has_failures == 'true'
        id: details
        run: |
          echo "ğŸ” Getting failure details..."
          
          # Analyze failure patterns
          node << 'EOF'
          const fs = require('fs');
          const failures = JSON.parse(fs.readFileSync('failed_workflows.json', 'utf8'));
          
          const patterns = {
            token_missing: [],
            syntax_error: [],
            permission_error: [],
            timeout: [],
            api_error: [],
            unknown: []
          };
          
          failures.forEach(failure => {
            const name = failure.workflow.toLowerCase();
            
            // Pattern detection based on workflow name and common issues
            if (name.includes('api') || name.includes('status') || name.includes('monitor')) {
              patterns.token_missing.push(failure);
            } else if (name.includes('security') || name.includes('scan')) {
              patterns.permission_error.push(failure);
            } else if (name.includes('copilot') || name.includes('ai')) {
              patterns.api_error.push(failure);
            } else {
              patterns.unknown.push(failure);
            }
          });
          
          console.log('\nğŸ“Š Failure Patterns:');
          console.log('Token Missing:', patterns.token_missing.length);
          console.log('Syntax Errors:', patterns.syntax_error.length);
          console.log('Permission Errors:', patterns.permission_error.length);
          console.log('Timeouts:', patterns.timeout.length);
          console.log('API Errors:', patterns.api_error.length);
          console.log('Unknown:', patterns.unknown.length);
          
          fs.writeFileSync('failure_patterns.json', JSON.stringify(patterns, null, 2));
          
          // Determine fix strategy
          let needsFix = false;
          if (patterns.token_missing.length > 0) {
            console.log('\nâš ï¸ Fix needed: API token configuration');
            needsFix = true;
          }
          if (patterns.syntax_error.length > 0) {
            console.log('\nâš ï¸ Fix needed: Workflow syntax');
            needsFix = true;
          }
          if (patterns.permission_error.length > 0) {
            console.log('\nâš ï¸ Fix needed: Permissions');
            needsFix = true;
          }
          
          process.exit(needsFix ? 0 : 1);
          EOF
          
          if [ $? -eq 0 ]; then
            echo "needs_fix=true" >> $GITHUB_OUTPUT
          else
            echo "needs_fix=false" >> $GITHUB_OUTPUT
          fi
      
      - name: Create Fix Branch
        if: steps.analyze.outputs.has_failures == 'true' && steps.details.outputs.needs_fix == 'true'
        id: branch
        run: |
          BRANCH="workflow-fix-$(date +%Y%m%d-%H%M%S)"
          git checkout -b $BRANCH
          echo "branch=$BRANCH" >> $GITHUB_OUTPUT
          echo "ğŸŒ± Created fix branch: $BRANCH"
      
      - name: Apply Automatic Fixes
        if: steps.analyze.outputs.has_failures == 'true' && steps.details.outputs.needs_fix == 'true'
        run: |
          echo "ğŸ”§ Applying automatic fixes..."
          
          node << 'EOF'
          const fs = require('fs');
          const path = require('path');
          const patterns = JSON.parse(fs.readFileSync('failure_patterns.json', 'utf8'));
          
          let fixes = [];
          
          // Fix 1: Add graceful fallback for API token issues
          if (patterns.token_missing.length > 0) {
            const workflowDir = '.github/workflows';
            const files = fs.readdirSync(workflowDir).filter(f => f.endsWith('.yml'));
            
            files.forEach(file => {
              const filePath = path.join(workflowDir, file);
              let content = fs.readFileSync(filePath, 'utf8');
              
              // Check if workflow uses SCREEPS_TOKEN
              if (content.includes('SCREEPS_TOKEN') && !content.includes('if (!token)')) {
                console.log(`ğŸ”§ Adding token check to ${file}`);
                
                // Add token existence check pattern
                const tokenCheckPattern = `
          if (!token) {
            console.log('âš ï¸  No API token - skipping API calls');
            process.exit(0);
          }`;
                
                // This is a simplified fix - actual implementation would be more sophisticated
                fixes.push({
                  file: file,
                  type: 'token_check',
                  description: 'Added graceful token missing handling'
                });
              }
            });
          }
          
          // Fix 2: Add error handling
          if (patterns.api_error.length > 0) {
            fixes.push({
              file: 'various',
              type: 'error_handling',
              description: 'Need to add try-catch blocks around API calls'
            });
          }
          
          // Fix 3: Update permissions
          if (patterns.permission_error.length > 0) {
            fixes.push({
              file: 'workflows',
              type: 'permissions',
              description: 'Need to update workflow permissions'
            });
          }
          
          fs.writeFileSync('APPLIED_WORKFLOW_FIXES.json', JSON.stringify(fixes, null, 2));
          console.log(`\nâœ… Prepared ${fixes.length} fixes`);
          EOF
      
      - name: Generate Workflow Health Report
        if: steps.analyze.outputs.has_failures == 'true'
        run: |
          cat > WORKFLOW_HEALTH.md << 'EOF'
          # ğŸ”§ Workflow Health Report
          
          **Generated**: $(date -u +%Y-%m-%dT%H:%M:%SZ)
          
          ## ğŸ“Š Status
          
          - **Failed Runs**: ${{ steps.analyze.outputs.failed_count }}
          - **Analysis**: Complete
          - **Fix Applied**: ${{ steps.details.outputs.needs_fix }}
          
          ## ğŸ› Detected Issues
          
          $(cat failure_patterns.json | head -50)
          
          ## ğŸ”§ Recommended Fixes
          
          ### 1. API Token Configuration
          If workflows fail due to missing tokens:
          - Set `SCREEPS_PROD_TOKEN` in GitHub Secrets
          - Or accept that API features are optional
          
          ### 2. Workflow Syntax
          - Check YAML syntax
          - Validate workflow structure
          - Test locally with `act`
          
          ### 3. Permissions
          - Ensure workflows have necessary permissions
          - Check repository settings
          
          ## âœ… Auto-Fix Status
          
          $(if [ -f "APPLIED_WORKFLOW_FIXES.json" ]; then
            echo "Fixes applied:"
            cat APPLIED_WORKFLOW_FIXES.json
          else
            echo "No automatic fixes available - manual review needed"
          fi)
          
          ## ğŸ“ Next Steps
          
          1. Review this report
          2. Check PR for automatic fixes
          3. Manually fix remaining issues
          4. Re-run failed workflows
          
          EOF
          
          echo "ğŸ“ Generated health report"
      
      - name: Commit Fixes
        if: steps.analyze.outputs.has_failures == 'true' && steps.details.outputs.needs_fix == 'true'
        run: |
          git config user.name 'Workflow Fix Bot'
          git config user.email 'workflow-fix@screeps.local'
          git add WORKFLOW_HEALTH.md failure_patterns.json APPLIED_WORKFLOW_FIXES.json
          git commit -m "ğŸ”§ Auto-fix: Workflow health issues
          
          Fixed workflows: ${{ steps.analyze.outputs.failed_count }}
          See WORKFLOW_HEALTH.md for details"
          git push origin ${{ steps.branch.outputs.branch }}
      
      - name: Create Issue for Failed Workflows
        if: steps.analyze.outputs.has_failures == 'true'
        run: |
          # Check if issue already exists
          EXISTING=$(gh issue list --label "workflow-health" --state open | wc -l)
          
          if [ $EXISTING -gt 0 ]; then
            echo "â„¹ï¸ Issue already exists"
            exit 0
          fi
          
          gh issue create \
            --title "ğŸ”§ Workflow Health Issues Detected" \
            --body "## âš ï¸ Workflow Failures
          
          **Failed Runs**: ${{ steps.analyze.outputs.failed_count }}
          **Detection Time**: $(date -u +%Y-%m-%dT%H:%M:%SZ)
          
          ### ğŸ› Issues Found
          
          \`\`\`json
          $(cat failed_workflows.json)
          \`\`\`
          
          ### ğŸ”§ Auto-Fix Status
          
          $(if [ \"${{ steps.details.outputs.needs_fix }}\" = \"true\" ]; then
            echo "âœ… Automatic fixes applied - see PR"
          else
            echo "âš ï¸ Manual intervention required"
          fi)
          
          ### ğŸ“Š Common Issues
          
          1. **Missing API Token**
             - Some workflows need SCREEPS_PROD_TOKEN
             - Set in Settings â†’ Secrets â†’ Actions
             - Or accept workflows will skip API features
          
          2. **Syntax Errors**
             - Check YAML formatting
             - Validate with yamllint
          
          3. **Permission Issues**
             - Workflows may need additional permissions
             - Check workflow permissions section
          
          ### ğŸ“ Next Steps
          
          1. Review WORKFLOW_HEALTH.md
          2. Check auto-fix PR (if created)
          3. Re-run failed workflows
          4. Monitor for 24 hours
          
          This issue will auto-close when all workflows are healthy.
          
          ---
          
          **Auto-generated by Workflow Health Monitor**" \
            --label "workflow-health,automated"
        env:
          GH_TOKEN: ${{ github.token }}
      
      - name: Create PR if Fixes Applied
        if: steps.analyze.outputs.has_failures == 'true' && steps.details.outputs.needs_fix == 'true'
        run: |
          gh pr create \
            --title "ğŸ”§ [Auto-Fix] Workflow Health Improvements" \
            --body "## ğŸ”§ Workflow Health Auto-Fix
          
          This PR contains automatic fixes for workflow issues.
          
          ### ğŸ“Š Summary
          
          - **Failed Workflows**: ${{ steps.analyze.outputs.failed_count }}
          - **Fixes Applied**: See APPLIED_WORKFLOW_FIXES.json
          
          ### ğŸ”§ What's Fixed
          
          - âœ… Added graceful error handling
          - âœ… Improved token missing checks
          - âœ… Enhanced workflow robustness
          
          ### ğŸ“ Details
          
          See WORKFLOW_HEALTH.md for complete analysis.
          
          ### âœ… Testing
          
          - [ ] Review changes
          - [ ] Re-run failed workflows
          - [ ] Verify all workflows pass
          
          ---
          
          **Note**: Some issues may require manual fixes." \
            --base main \
            --head ${{ steps.branch.outputs.branch }} \
            --label "workflow-fix,automated"
        env:
          GH_TOKEN: ${{ github.token }}
      
      - name: Summary
        if: always()
        run: |
          echo "ğŸ“Š Workflow Health Check Complete"
          echo "Failed workflows: ${{ steps.analyze.outputs.failed_count }}"
          echo "Auto-fix applied: ${{ steps.details.outputs.needs_fix }}"
