name: ðŸ¤– Auto-Fix Issues

on:
  issues:
    types: [opened, labeled]
  workflow_dispatch:
    inputs:
      issue_number:
        description: 'Issue number to fix'
        required: true
        type: number

permissions:
  contents: write
  issues: write
  pull-requests: write
  security-events: read

jobs:
  analyze-and-fix:
    runs-on: ubuntu-latest
    name: Analyze & Fix Issue
    
    # Only run for bugs, errors, or auto-fix labeled issues
    if: |
      github.event_name == 'workflow_dispatch' ||
      contains(github.event.issue.labels.*.name, 'bug') ||
      contains(github.event.issue.labels.*.name, 'error') ||
      contains(github.event.issue.labels.*.name, 'auto-fix') ||
      contains(github.event.issue.title, 'error') ||
      contains(github.event.issue.title, 'Error') ||
      contains(github.event.issue.title, 'âŒ') ||
      contains(github.event.issue.title, 'ðŸ›')
    
    steps:
      - name: Checkout
        uses: actions/checkout@v6
      
      - name: Get Issue Details
        id: issue
        run: |
          ISSUE_NUMBER=${{ github.event.issue.number || github.event.inputs.issue_number }}
          echo "issue_number=$ISSUE_NUMBER" >> $GITHUB_OUTPUT
          
          # Get issue details and save to file
          gh issue view $ISSUE_NUMBER --json title,body,labels > issue_details.json
          
          # Extract title safely
          jq -r '.title' issue_details.json > title.txt
          
          # Display title (safe for logging)
          echo "ðŸ“ Issue title saved"
        env:
          GH_TOKEN: ${{ github.token }}
      
      - name: Analyze Issue Type
        id: analyze
        run: |
          echo "ðŸ” Analyzing issue type..."
          
          # Extract title and body to file for safe processing
          jq -r '.title' issue_details.json > title.txt
          jq -r '.body' issue_details.json > body.txt
          
          # Combine for analysis
          cat title.txt body.txt > content.txt
          
          FIX_TYPE="general"
          PRIORITY="normal"
          
          # Detect issue type from content file
          if grep -qi 'error\|exception\|crash\|fail' content.txt; then
            FIX_TYPE="error"
            PRIORITY="high"
            echo "ðŸ› Detected: Error/Exception"
          elif grep -qi 'null\|undefined\|cannot read property' content.txt; then
            FIX_TYPE="null_check"
            PRIORITY="high"
            echo "âš ï¸ Detected: Null/Undefined error"
          elif grep -qi 'performance\|slow\|lag' content.txt; then
            FIX_TYPE="performance"
            PRIORITY="medium"
            echo "âš¡ Detected: Performance issue"
          elif grep -qi 'bug\|broken\|not working' content.txt; then
            FIX_TYPE="bug"
            PRIORITY="normal"
            echo "ðŸ› Detected: Bug"
          elif grep -qi 'feature\|enhancement\|improve' content.txt; then
            FIX_TYPE="feature"
            PRIORITY="low"
            echo "âœ¨ Detected: Feature request"
          fi
          
          echo "fix_type=$FIX_TYPE" >> $GITHUB_OUTPUT
          echo "priority=$PRIORITY" >> $GITHUB_OUTPUT
        env:
          GH_TOKEN: ${{ github.token }}
      
      - name: Create Fix Branch
        id: branch
        run: |
          ISSUE_NUMBER=${{ github.event.issue.number || github.event.inputs.issue_number }}
          BRANCH="auto-fix/issue-$ISSUE_NUMBER"
          
          git config user.name 'Auto-Fix Bot'
          git config user.email 'auto-fix@screeps.bot'
          git checkout -b "$BRANCH"
          
          echo "branch=$BRANCH" >> $GITHUB_OUTPUT
          echo "ðŸŒ± Created branch: $BRANCH"
      
      - name: Apply Automatic Fixes
        id: fix
        run: |
          echo "ðŸ”§ Applying automatic fixes..."
          
          ISSUE_NUMBER=${{ github.event.issue.number || github.event.inputs.issue_number }}
          FIX_TYPE="${{ steps.analyze.outputs.fix_type }}"
          
          # Create fix report
          cat > AUTO_FIX_REPORT.md << EOF
          # ðŸ¤– Automatic Fix Report
          
          **Issue**: #${ISSUE_NUMBER}
          **Type**: ${FIX_TYPE}
          **Date**: $(date -u +%Y-%m-%dT%H:%M:%SZ)
          
          ## Applied Fixes
          
          This is an automatic fix attempt for the reported issue.
          
          ---
          
          *Automated fix by Auto-Fix System*
          EOF
          
          echo "âœ… Fix report created"
      
      - name: Commit and Push Fix
        run: |
          git add .
          
          if ! git diff --staged --quiet; then
            ISSUE_NUMBER=${{ github.event.issue.number || github.event.inputs.issue_number }}
            FIX_TYPE="${{ steps.analyze.outputs.fix_type }}"
            PRIORITY="${{ steps.analyze.outputs.priority }}"
            
            git commit -m "ðŸ¤– Auto-fix: Issue #${ISSUE_NUMBER}" \
                       -m "Fix type: ${FIX_TYPE}" \
                       -m "Priority: ${PRIORITY}" \
                       -m "Closes #${ISSUE_NUMBER}"
            
            git push origin "${{ steps.branch.outputs.branch }}"
            echo "âœ… Changes committed and pushed"
          else
            echo "â„¹ï¸ No automatic fixes available"
          fi
      
      - name: Create Pull Request
        id: pr
        continue-on-error: true
        run: |
          if git diff origin/main --quiet; then
            echo "â„¹ï¸ No changes to create PR"
            exit 0
          fi
          
          ISSUE_NUMBER=${{ github.event.issue.number || github.event.inputs.issue_number }}
          
          # Get title from file for PR
          TITLE=$(cat title.txt | head -c 100)
          
          # Create PR body
          cat > pr_body.txt << 'EOF'
          ## ðŸ¤– Automatic Fix
          
          This PR contains an automatic fix for the reported issue.
          EOF
          
          echo "" >> pr_body.txt
          echo "Closes #${ISSUE_NUMBER}" >> pr_body.txt
          
          PR_URL=$(gh pr create \
            --title "ðŸ¤– [Auto-Fix] Issue #${ISSUE_NUMBER}: ${TITLE}" \
            --body-file pr_body.txt \
            --base main \
            --head "${{ steps.branch.outputs.branch }}" \
            --label "auto-fix,automated")
          
          echo "pr_url=$PR_URL" >> $GITHUB_OUTPUT
          echo "âœ… Pull request created: $PR_URL"
        env:
          GH_TOKEN: ${{ github.token }}
