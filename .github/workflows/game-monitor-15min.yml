name: ‚è±Ô∏è Game Monitor (Hybrid Mode)

on:
  schedule:
    - cron: '*/15 * * * *'
  workflow_dispatch:

permissions:
  contents: write
  issues: write

jobs:
  monitor-hybrid:
    runs-on: ubuntu-latest
    name: Monitor Game (Hybrid Mode)
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '24'
      
      - name: Fetch Console Logs & Stats
        id: fetch
        env:
          SCREEPS_TOKEN: ${{ secrets.SCREEPS_PROD_TOKEN || secrets.SCREEPS_TOKEN }}
        run: |
          node << 'EOF'
          const https = require('https');
          const fs = require('fs');
          
          const token = process.env.SCREEPS_TOKEN;
          
          const api = (path) => new Promise((ok, fail) => {
            if (!token) {
              fail(new Error('No API token'));
              return;
            }
            
            const req = https.request({
              hostname: 'screeps.com',
              port: 443,
              path: path,
              method: 'GET',
              headers: { 'X-Token': token }
            }, res => {
              let data = '';
              res.on('data', d => data += d);
              res.on('end', () => {
                try {
                  ok(JSON.parse(data));
                } catch(e) {
                  fail(e);
                }
              });
            });
            req.on('error', fail);
            req.end();
          });
          
          (async () => {
            try {
              if (!token) {
                console.log('‚ö†Ô∏è  No API token - stats & logs not available');
                console.log('üí° Set SCREEPS_PROD_TOKEN in GitHub Secrets for full features');
                
                // Create basic status without API
                const basicStatus = `# üéÆ Game Status (GitHub Sync Mode)
          
          **Updated**: ${new Date().toISOString()}
          **Mode**: GitHub Sync (Deploy only) ‚úÖ
          
          ---
          
          ## üìä Statistics
          
          ‚ö†Ô∏è  API token not set - Real-time stats unavailable.
          
          To enable:
          1. Get token from https://screeps.com ‚Üí Account Settings ‚Üí API
          2. Add to GitHub Secrets as SCREEPS_PROD_TOKEN
          
          ## üìù Console Logs
          
          ‚ö†Ô∏è  API token not set - Console logs unavailable.
          
          Check logs in Screeps game console:
          \`\`\`javascript
          Memory.logs.slice(-10)
          \`\`\`
          
          ---
          
          **Code deployment**: Active via GitHub Sync ‚úÖ
          **Error auto-fix**: Active ‚úÖ
          `;
                
                fs.writeFileSync('GAME_STATUS.md', basicStatus);
                process.exit(0);
              }
              
              // Fetch data with API
              const [user, rooms, memory] = await Promise.all([
                api('/api/auth/me'),
                api('/api/user/rooms'),
                api('/api/user/memory')
              ]);
              
              const timestamp = new Date().toISOString();
              const logs = memory?.data?.logs || [];
              const errors = logs.filter(l => l.level === 'error');
              
              // Generate status with real-time data
              let status = '# üéÆ Game Status (Hybrid Mode)\n\n';
              status += `**Updated**: ${timestamp}\n`;
              status += `**Mode**: GitHub Sync + API Stats ‚úÖ\n\n`;
              status += '---\n\n';
              
              status += `## üë§ Player\n\n`;
              status += `- **Username**: ${user.username}\n`;
              status += `- **GCL**: ${Math.floor(user.gcl || 0)}\n`;
              status += `- **CPU**: ${user.cpu}\n`;
              status += `- **Credits**: ${user.money?.toLocaleString() || 0}\n\n`;
              
              if (rooms.rooms?.length) {
                status += `## üè∞ Rooms (${rooms.rooms.length})\n\n`;
                rooms.rooms.forEach(r => {
                  status += `- **${r.name}**: RCL${r.level || 0}\n`;
                });
                status += '\n';
              }
              
              if (memory.data?.creeps) {
                const creeps = Object.values(memory.data.creeps);
                const roles = {};
                creeps.forEach(c => {
                  const role = c.role || 'unknown';
                  roles[role] = (roles[role] || 0) + 1;
                });
                
                status += `## üêõ Creeps (${creeps.length})\n\n`;
                Object.entries(roles).sort((a, b) => b[1] - a[1]).forEach(([role, count]) => {
                  status += `- **${role}**: ${count}\n`;
                });
                status += '\n';
              }
              
              if (errors.length > 0) {
                status += `## ‚ö†Ô∏è  Errors (${errors.length})\n\n`;
                errors.slice(-5).forEach(e => {
                  status += `- **[${e.time}]** ${e.message}\n`;
                });
                status += '\n';
                fs.writeFileSync('DETECTED_ERRORS.json', JSON.stringify(errors, null, 2));
                fs.writeFileSync('.github/HAS_ERRORS', 'true');
              } else {
                fs.writeFileSync('.github/HAS_ERRORS', 'false');
                if (fs.existsSync('DETECTED_ERRORS.json')) {
                  fs.unlinkSync('DETECTED_ERRORS.json');
                }
              }
              
              status += '---\n\n';
              status += '## üìã System Status\n\n';
              status += '- **Deployment**: GitHub Sync ‚úÖ\n';
              status += '- **Statistics**: API Real-time ‚úÖ\n';
              status += '- **Console Logs**: Available below ‚úÖ\n';
              status += '- **Error Auto-Fix**: Active ‚úÖ\n\n';
              status += '---\n\n';
              status += '*Updated every 15 minutes*\n';
              
              fs.writeFileSync('GAME_STATUS.md', status);
              
              // Generate console logs
              if (logs.length > 0) {
                let consoleLogs = '# üìù Console Logs\n\n';
                consoleLogs += `**Updated**: ${timestamp}\n\n`;
                consoleLogs += '---\n\n';
                
                const recentLogs = logs.slice(-50).reverse();
                recentLogs.forEach(log => {
                  const emoji = {
                    'error': '‚ùå',
                    'warn': '‚ö†Ô∏è',
                    'info': '‚ÑπÔ∏è',
                    'debug': 'üîç'
                  }[log.level] || 'üí¨';
                  
                  consoleLogs += `${emoji} **[Tick ${log.time}]** ${log.message}\n\n`;
                });
                
                consoleLogs += '---\n\n';
                consoleLogs += `**Total Logs**: ${logs.length}\n`;
                consoleLogs += `**Errors**: ${logs.filter(l => l.level === 'error').length}\n`;
                consoleLogs += `**Warnings**: ${logs.filter(l => l.level === 'warn').length}\n`;
                consoleLogs += `**Info**: ${logs.filter(l => l.level === 'info').length}\n\n`;
                consoleLogs += '*Showing last 50 logs*\n';
                
                fs.writeFileSync('CONSOLE_LOGS.md', consoleLogs);
              }
              
              console.log('‚úÖ Status updated with real-time data');
              if (errors.length > 0) {
                console.log(`‚ö†Ô∏è  ${errors.length} errors detected`);
              }
              
            } catch(e) {
              console.error('‚ùå Error fetching data:', e.message);
              
              const errorStatus = `# üéÆ Game Status\n\n‚ùå Error: ${e.message}\n\n`;
              errorStatus += 'Check API token in GitHub Secrets.\n';
              fs.writeFileSync('GAME_STATUS.md', errorStatus);
            }
          })();
          EOF
      
      - name: Commit Changes
        run: |
          git config user.name 'Game Monitor Bot'
          git config user.email 'monitor@screeps.local'
          git add GAME_STATUS.md CONSOLE_LOGS.md DETECTED_ERRORS.json .github/HAS_ERRORS || true
          
          if ! git diff --staged --quiet; then
            git commit -m "‚è±Ô∏è  Stats & logs update: $(date '+%Y-%m-%d %H:%M')"
            git push
          fi
      
      - name: Trigger Auto-Fix
        if: success()
        run: |
          if [ -f ".github/HAS_ERRORS" ] && [ "$(cat .github/HAS_ERRORS)" = "true" ]; then
            echo "üîß Errors detected - triggering auto-fix"
            gh workflow run auto-fix-errors.yml || echo "Auto-fix will run on next schedule"
          fi
        env:
          GH_TOKEN: ${{ github.token }}
