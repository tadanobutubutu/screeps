name: ğŸ¤– AI Repository Manager

on:
  schedule:
    # Every 6 hours
    - cron: '15 */6 * * *'
  workflow_dispatch:

permissions:
  contents: write

jobs:
  autonomous-improvement:
    runs-on: ubuntu-latest
    name: Autonomous Repository Enhancement
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: ğŸ§  AI Analysis and Auto-Improvement
        env:
          GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
        run: |
          node -e "
          const https = require('https');
          const fs = require('fs');
          const path = require('path');

          // Load policy
          let policy = { complexity_level: 1, temperature_base: 0.7, focus_areas: {} };
          if (fs.existsSync('ai-policy.json')) {
            policy = JSON.parse(fs.readFileSync('ai-policy.json', 'utf8'));
          }

          function getAllFiles(dir, files = []) {
            const entries = fs.readdirSync(dir, { withFileTypes: true });
            for (const entry of entries) {
              const fullPath = path.join(dir, entry.name);
              if (entry.name.startsWith('.') || entry.name === 'node_modules') continue;
              if (entry.isDirectory()) {
                getAllFiles(fullPath, files);
              } else if (entry.name.endsWith('.js')) {
                files.push(fullPath);
              }
            }
            return files;
          }

          const jsFiles = getAllFiles('.');
          const fileContents = {};
          jsFiles.forEach(file => {
            fileContents[file] = fs.readFileSync(file, 'utf8');
          });

          const fileList = Object.keys(fileContents).map(f => 
            \`\${f}:\n\${fileContents[f].substring(0, 500)}...\`
          ).join('\n\n');

          const prompt = \`ã‚ãªãŸã¯Screepsãƒœãƒƒãƒˆãƒªãƒã‚¸ãƒˆãƒªã‚’ç®¡ç†ã™ã‚‹è‡ªå¾‹AIã§ã™ã€‚ç¾åœ¨ã®ã‚³ãƒ¼ãƒ‰ãƒ™ãƒ¼ã‚¹ã‚’åˆ†æã—ã¦æ”¹å–„ã‚’æ±ºå®šã—ã¦ãã ã•ã„ã€‚

ç¾åœ¨ã®ãƒãƒªã‚·ãƒ¼:
- è¤‡é›‘åº¦ãƒ¬ãƒ™ãƒ«: \${policy.complexity_level}/10
- æ¸©åº¦: \${policy.temperature_base}
- ãƒ•ã‚©ãƒ¼ã‚«ã‚¹ã‚¨ãƒªã‚¢: \${JSON.stringify(policy.focus_areas)}

ç¾åœ¨ã®ãƒ•ã‚¡ã‚¤ãƒ«æ¦‚è¦:
\${fileList}

å®Œå…¨ãªãƒ•ã‚¡ã‚¤ãƒ«ãƒªã‚¹ãƒˆ:
\${JSON.stringify(Object.keys(fileContents), null, 2)}

ã‚¿ã‚¹ã‚¯:
1. æ–°è¦ãƒ•ã‚¡ã‚¤ãƒ«ä½œæˆ OR æ—¢å­˜ãƒ•ã‚¡ã‚¤ãƒ«æ›´æ–°ã‚’1ã¤é¸æŠ
2. è¤‡é›‘åº¦ãƒ¬ãƒ™ãƒ«\${policy.complexity_level}ã«é©ã—ãŸæ”¹å–„ã‚’å®Ÿæ–½
3. ãƒ•ã‚©ãƒ¼ã‚«ã‚¹ã‚¨ãƒªã‚¢ã®é…åˆ†ã«å¾“ã£ã¦æ”¹å–„ã‚«ãƒ†ã‚´ãƒªã‚’é¸æŠ

æ”¹å–„ã‚¢ã‚¤ãƒ‡ã‚¢:
- æ–°ã—ã„roleãƒ•ã‚¡ã‚¤ãƒ«ï¼ˆrole.miner.js, role.claimer.js, role.warrior.jsç­‰ï¼‰
- æ–°ã—ã„utilityãƒ•ã‚¡ã‚¤ãƒ«ï¼ˆutils.pathfinding.js, utils.market.js, utils.tower.jsç­‰ï¼‰
- æ—¢å­˜roleã®æ©Ÿèƒ½å¼·åŒ–
- main.jsã¸ã®æ–°æ©Ÿèƒ½è¿½åŠ 
- ç›£è¦–ãƒ»åˆ†æãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«
- roomæ‹¡å¼µãƒ­ã‚¸ãƒƒã‚¯
- ã‚¨ãƒãƒ«ã‚®ãƒ¼ç®¡ç†æœ€é©åŒ–

ä»¥ä¸‹ã®JSONå½¢å¼ã§è¿”ã—ã¦ãã ã•ã„:
{
  \"action\": \"create\" or \"update\",
  \"filename\": \"exact/path/to/file.js\",
  \"category\": \"performance\"|\"new_features\"|\"optimization\"|\"creative\"|\"infrastructure\",
  \"complexity\": 1-10,
  \"risk\": \"low\"|\"medium\"|\"high\",
  \"description\": \"Brief English description\",
  \"description_ja\": \"è©³ã—ã„æ—¥æœ¬èªèª¬æ˜ï¼ˆä½•ã‚’ãªãœæ”¹å–„ã—ãŸã‹ã€ã©ã†ã„ã†åŠ¹æœãŒæœŸå¾…ã§ãã‚‹ã‹ï¼‰\",
  \"code\": \"<complete file content>\"
}\`;

          const body = JSON.stringify({
            contents: [{ parts: [{ text: prompt }] }],
            generationConfig: { 
              temperature: policy.temperature_base, 
              maxOutputTokens: 8192 
            }
          });

          const options = {
            hostname: 'generativelanguage.googleapis.com',
            path: '/v1beta/models/gemini-2.0-flash:generateContent?key=' + process.env.GEMINI_API_KEY,
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
              'Content-Length': Buffer.byteLength(body)
            }
          };

          const req = https.request(options, (res) => {
            let data = '';
            res.on('data', chunk => data += chunk);
            res.on('end', () => {
              try {
                const response = JSON.parse(data);
                const text = response.candidates[0].content.parts[0].text;
                const cleaned = text.replace(/\`\`\`json\n?/g, '').replace(/\`\`\`\n?/g, '').trim();
                const decision = JSON.parse(cleaned);
                
                console.log('ğŸ¤– AI Decision:', decision.description_ja);
                console.log('ğŸ“ Action:', decision.action);
                console.log('ğŸ“„ File:', decision.filename);
                console.log('ğŸ¯ Category:', decision.category);
                console.log('ğŸ“Š Complexity:', decision.complexity);
                console.log('âš ï¸  Risk:', decision.risk);
                
                const dir = path.dirname(decision.filename);
                if (!fs.existsSync(dir)) {
                  fs.mkdirSync(dir, { recursive: true });
                }
                
                fs.writeFileSync(decision.filename, decision.code);
                
                const logEntry = {
                  timestamp: new Date().toISOString(),
                  action: decision.action,
                  filename: decision.filename,
                  category: decision.category,
                  complexity: decision.complexity,
                  risk: decision.risk,
                  description: decision.description,
                  description_ja: decision.description_ja,
                  policy_version: policy.version || 1
                };
                
                let log = [];
                if (fs.existsSync('ai-decisions.json')) {
                  log = JSON.parse(fs.readFileSync('ai-decisions.json', 'utf8'));
                }
                log.push(logEntry);
                fs.writeFileSync('ai-decisions.json', JSON.stringify(log, null, 2));
                
                // Update META-CHANGELOG
                const today = new Date().toISOString().split('T')[0];
                let changelog = '';
                if (fs.existsSync('META-CHANGELOG.md')) {
                  changelog = fs.readFileSync('META-CHANGELOG.md', 'utf8');
                }
                
                const timeStr = new Date().toLocaleTimeString('ja-JP', { timeZone: 'Asia/Tokyo', hour: '2-digit', minute: '2-digit' });
                const entry = \`\n### \${timeStr} - ğŸ¤– è‡ªå¾‹æ”¹å–„\n\n**ãƒ•ã‚¡ã‚¤ãƒ«**: \\`\${decision.filename}\\`  \n**ã‚¢ã‚¯ã‚·ãƒ§ãƒ³**: \${decision.action === 'create' ? 'æ–°è¦ä½œæˆ' : 'æ›´æ–°'}  \n**ã‚«ãƒ†ã‚´ãƒª**: \${decision.category}  \n**è¤‡é›‘åº¦**: \${decision.complexity}/10  \n**ãƒªã‚¹ã‚¯**: \${decision.risk}\n\n**èª¬æ˜**:  \n\${decision.description_ja}\n\`;
                
                if (changelog.includes(\`## \${today}\`)) {
                  changelog = changelog.replace(\`## \${today}\`, \`## \${today}\${entry}\`);
                } else {
                  changelog = \`## \${today}\n\${entry}\n\${changelog}\`;
                }
                
                fs.writeFileSync('META-CHANGELOG.md', changelog);
                
                console.log('âœ… Autonomous improvement completed!');
              } catch(e) {
                console.error('âŒ Failed to parse AI response:', e.message);
                console.error('Raw response:', data.substring(0, 500));
                process.exit(1);
              }
            });
          });
          req.on('error', e => { console.error(e); process.exit(1); });
          req.write(body);
          req.end();
          "

      - name: ğŸ“ Commit AI Changes
        run: |
          git config --global user.name 'AI Repository Manager'
          git config --global user.email 'ai-manager@screeps-bot.local'
          git add -A
          
          if git diff --staged --quiet; then
            echo "No changes to commit"
          else
            DESCRIPTION=$(node -e "const log = require('./ai-decisions.json'); console.log(log[log.length-1].description);" 2>/dev/null || echo "Auto-improvement")
            git commit -m "ğŸ¤– AI: ${DESCRIPTION}"
            git push
          fi
