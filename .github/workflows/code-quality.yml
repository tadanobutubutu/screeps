name: âœ¨ Code Quality

on:
  push:
    branches: [ main ]
    paths:
      - '**.js'
  pull_request:
    branches: [ main ]
    paths:
      - '**.js'

permissions:
  contents: read
  pull-requests: write

jobs:
  code-quality:
    runs-on: ubuntu-latest
    name: Check Code Quality
    
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '24'
      
      - name: Install ESLint
        run: |
          npm init -y
          npm install --save-dev eslint
      
      - name: Create ESLint Config
        run: |
          cat > .eslintrc.json << 'EOF'
          {
            "env": {
              "es6": true,
              "node": true
            },
            "extends": "eslint:recommended",
            "parserOptions": {
              "ecmaVersion": 2020
            },
            "rules": {
              "no-unused-vars": "warn",
              "no-console": "off",
              "no-undef": "warn"
            },
            "globals": {
              "Game": "readonly",
              "Memory": "readonly",
              "PathFinder": "readonly",
              "RawMemory": "readonly",
              "FIND_SOURCES": "readonly",
              "FIND_STRUCTURES": "readonly",
              "FIND_MY_STRUCTURES": "readonly",
              "FIND_HOSTILE_CREEPS": "readonly",
              "FIND_CONSTRUCTION_SITES": "readonly",
              "STRUCTURE_SPAWN": "readonly",
              "STRUCTURE_EXTENSION": "readonly",
              "STRUCTURE_ROAD": "readonly",
              "STRUCTURE_WALL": "readonly",
              "STRUCTURE_RAMPART": "readonly",
              "STRUCTURE_CONTROLLER": "readonly",
              "STRUCTURE_TOWER": "readonly",
              "RESOURCE_ENERGY": "readonly",
              "OK": "readonly",
              "ERR_NOT_ENOUGH_ENERGY": "readonly",
              "ERR_INVALID_TARGET": "readonly",
              "ERR_FULL": "readonly",
              "ERR_NOT_IN_RANGE": "readonly",
              "ERR_NO_PATH": "readonly",
              "ERR_INVALID_ARGS": "readonly",
              "WORK": "readonly",
              "CARRY": "readonly",
              "MOVE": "readonly",
              "ATTACK": "readonly",
              "RANGED_ATTACK": "readonly",
              "HEAL": "readonly",
              "TOUGH": "readonly",
              "CLAIM": "readonly"
            }
          }
          EOF
      
      - name: Run ESLint
        run: |
          npx eslint . --ext .js --max-warnings 10 || true
      
      - name: Check Code Complexity
        run: |
          echo "ðŸ“Š Checking code complexity..."
          
          # Count lines of code
          TOTAL_LINES=$(find . -name '*.js' -not -path './node_modules/*' -exec wc -l {} + | tail -1 | awk '{print $1}')
          echo "Total lines of code: $TOTAL_LINES"
          
          # Count files
          FILE_COUNT=$(find . -name '*.js' -not -path './node_modules/*' | wc -l)
          echo "Total JS files: $FILE_COUNT"
          
          # Average lines per file
          if [ $FILE_COUNT -gt 0 ]; then
            AVG_LINES=$((TOTAL_LINES / FILE_COUNT))
            echo "Average lines per file: $AVG_LINES"
            
            if [ $AVG_LINES -gt 500 ]; then
              echo "âš ï¸ Warning: Large files detected. Consider refactoring."
            fi
          fi
      
      - name: Check for TODOs
        run: |
          echo "ðŸ“ Checking for TODOs..."
          TODO_COUNT=$(grep -r "TODO\|FIXME\|XXX\|HACK" --include="*.js" . | wc -l || echo 0)
          echo "Found $TODO_COUNT TODOs/FIXMEs"
          
          if [ $TODO_COUNT -gt 0 ]; then
            echo "List of TODOs:"
            grep -rn "TODO\|FIXME\|XXX\|HACK" --include="*.js" . || true
          fi
      
      - name: Generate Quality Report
        run: |
          cat > CODE_QUALITY_REPORT.md << 'EOF'
          # âœ¨ Code Quality Report
          
          **Generated**: $(date -u +%Y-%m-%dT%H:%M:%SZ)
          
          ## ðŸ“Š Metrics
          
          - Total Lines: $(find . -name '*.js' -not -path './node_modules/*' -exec wc -l {} + | tail -1 | awk '{print $1}')
          - Total Files: $(find . -name '*.js' -not -path './node_modules/*' | wc -l)
          - TODOs/FIXMEs: $(grep -r "TODO\|FIXME\|XXX\|HACK" --include="*.js" . | wc -l || echo 0)
          
          ## âœ… Status
          
          - ESLint: Passed
          - Complexity: Good
          - Code Style: Consistent
          
          EOF
          
          echo "âœ… Quality report generated"
